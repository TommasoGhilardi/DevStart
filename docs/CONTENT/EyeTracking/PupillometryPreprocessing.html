<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.47">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Tommaso Ghilardi">
<meta name="keywords" content="pupil dilation, pupillometry, eye-tracking, experiments, infant research, DevStart, developmental science">
<meta name="description" content="Learn the fundamentals of pupil dilation processing using PupillometryR">
<title>Pre-processing Pupillometry ‚Äì DevStart</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../CONTENT/EyeTracking/FromFixationsToData.html" rel="prev">
<link href="../../images/ICON.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-G5XSH1GLW7"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-G5XSH1GLW7', { 'anonymize_ip': true});
</script><meta name="quarto:status" content="draft">
<meta property="og:title" content="DevStart">
<meta property="og:description" content="Getting started with developmental science">
<meta property="og:image" content="https://tommasoghilardi.github.io/DevStart/CONTENT/EyeTracking/images/ICON.png">
<meta property="og:site_name" content="DevStart">
<meta name="twitter:title" content="DevStart">
<meta name="twitter:description" content="Language, stats, R">
<meta name="twitter:image" content="https://tommasoghilardi.github.io/DevStart/CONTENT/EyeTracking/images/ICON.png">
<meta name="twitter:site" content="@DevSciStart">
<meta name="twitter:card" content="summary">
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><div id="quarto-draft-alert" class="alert alert-warning"><i class="bi bi-pencil-square"></i>Draft</div><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../CONTENT/EyeTracking/Intro_eyetracking.html">Eye-tracking</a></li><li class="breadcrumb-item"><a href="../../CONTENT/EyeTracking/PupillometryPreprocessing.html">Pre-processing Pupillometry</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-center sidebar-header sidebar-header-stacked">
      <a href="../../index.html" class="sidebar-logo-link">
      <img src="../../images/LOGO.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none"></a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../../"></a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://x.com/DevSciStart" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-twitter"></i></a>
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label=""><i class="bi bi-github"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
<li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://github.com/TommasoGhilardi/DevStart">
            Source Code
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://github.com/TommasoGhilardi/DevStart/issues">
            Report a Bug
            </a>
          </li>
      </ul>
</div>
    <a href="../../CONTENT/ContentList.html" title="Content listing" class="quarto-navigation-tool px-1" aria-label="Content listing"><i class="bi bi-menu-up"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome to DevStart</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Getting started:</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../CONTENT/GettingStarted/GettingStartedWithPython.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Starting with Python</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../CONTENT/GettingStarted/GettingStartedWithPsychopy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Starting with PsychoPy</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../CONTENT/GettingStarted/CreateYourFirstParadigm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Creating an experiment:</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../CONTENT/GettingStarted/CreateYourFirstParadigm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Create your first paradigm</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../CONTENT/EyeTracking/Intro_eyetracking.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Eye-tracking</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../CONTENT/EyeTracking/Intro_eyetracking.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to eye-tracking</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../CONTENT/EyeTracking/CreateAnEyetrackingExperiment.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Create an eye-tracking experiment</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../CONTENT/EyeTracking/EyetrackingCalibration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Calibrating eye-tracking</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../CONTENT/EyeTracking/I2MC_tutorial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Using I2MC for robust fixation extraction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../CONTENT/EyeTracking/FromFixationsToData.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">From fixations to measures</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="https://tommasoghilardi.github.io/DevStart/Workshops/" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Workshops</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://tommasoghilardi.github.io/DevStart/Workshops/" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Eye-Tracking Workshop for Developmental Scientists</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://tommasoghilardi.github.io/DevStart/Workshops/PreviousWokshops/BTG2024.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">BTG 2024</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="4"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li><a href="#read-the-data" id="toc-read-the-data" class="nav-link active" data-scroll-target="#read-the-data">Read the data</a></li>
  <li>
<a href="#prepare-the-data" id="toc-prepare-the-data" class="nav-link" data-scroll-target="#prepare-the-data">Prepare the data</a>
  <ul class="collapse">
<li><a href="#make-pupillometryr-data" id="toc-make-pupillometryr-data" class="nav-link" data-scroll-target="#make-pupillometryr-data">Make pupillometryR data</a></li>
  </ul>
</li>
  <li>
<a href="#pre-processing" id="toc-pre-processing" class="nav-link" data-scroll-target="#pre-processing">Pre-processing</a>
  <ul class="collapse">
<li><a href="#regress" id="toc-regress" class="nav-link" data-scroll-target="#regress">Regress</a></li>
  <li><a href="#mean-pupil" id="toc-mean-pupil" class="nav-link" data-scroll-target="#mean-pupil">Mean pupil</a></li>
  <li><a href="#lowpass" id="toc-lowpass" class="nav-link" data-scroll-target="#lowpass">Lowpass</a></li>
  <li><a href="#downsample" id="toc-downsample" class="nav-link" data-scroll-target="#downsample">Downsample</a></li>
  <li><a href="#trial-rejection" id="toc-trial-rejection" class="nav-link" data-scroll-target="#trial-rejection">Trial Rejection</a></li>
  <li><a href="#fill-the-signal" id="toc-fill-the-signal" class="nav-link" data-scroll-target="#fill-the-signal">Fill the signal</a></li>
  <li><a href="#baseline-correction" id="toc-baseline-correction" class="nav-link" data-scroll-target="#baseline-correction">Baseline Correction</a></li>
  <li><a href="#save-and-analysis" id="toc-save-and-analysis" class="nav-link" data-scroll-target="#save-and-analysis">Save and analysis</a></li>
  </ul>
</li>
  <li><a href="#all-code" id="toc-all-code" class="nav-link" data-scroll-target="#all-code">All code</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../CONTENT/EyeTracking/Intro_eyetracking.html">Eye-tracking</a></li><li class="breadcrumb-item"><a href="../../CONTENT/EyeTracking/PupillometryPreprocessing.html">Pre-processing Pupillometry</a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Pre-processing Pupillometry</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i></button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
  <div class="quarto-categories">
    <div class="quarto-category">Pupillometry</div>
    <div class="quarto-category">R</div>
    <div class="quarto-category">Pre-processing</div>
  </div>
  </div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

<div>
  <div class="keywords">
    <div class="block-title">Keywords</div>
    <p>pupil dilation, pupillometry, eye-tracking, experiments, infant research, DevStart, developmental science</p>
  </div>
</div>

</header><p>Welcome to your first step into the world of pupillometry! In this tutorial, we‚Äôll walk you through how to preprocess pupil data using a handy R package called <a href="http://samforbes.me/PupillometryR/index.html">PupillometryR</a>. This package makes it simple to clean and even analyze your pupil data with just a few lines of R code.</p>
<p>To keep things straightforward, we‚Äôll be working with a simulated dataset that you can download right here (insert link). This dataset is based on the experimental design we introduced earlier in our eye-tracking series. If you‚Äôre not familiar with it or need a quick refresher, we recommend checking out the ‚Äú<a href="../../CONTENT/EyeTracking/Intro_eyetracking.html">Introduction to eye-tracking</a>‚Äù guide before diving in.</p>
<p>This tutorial serves as a foundation for understanding how to preprocess pupil data. Once you‚Äôve grasped the essentials, we encourage you to explore the full range of functions and features <a href="http://samforbes.me/PupillometryR">PupillometryR</a> has to offer.</p>
<section id="read-the-data" class="level2"><h2 class="anchored" data-anchor-id="read-the-data">Read the data</h2>
<p>Let‚Äôs begin by importing the necessary libraries and loading the downloaded dataframe.</p>
<p>Perfect now let‚Äôs read our dataframe</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Raw_data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="st">"..\\..\\resources\\Pupillometry\\PupilData.csv"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">Raw_data</span><span class="op">)</span> <span class="co"># database peak</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  X   Subject      Time   PupilL   PupilR   Events TrialN
1 1 Subject_1  1.000000 3.704922 3.298884 Fixation      1
2 2 Subject_1  4.333526 3.697448 3.292230     &lt;NA&gt;     NA
3 3 Subject_1  7.667052 3.679314 3.276083     &lt;NA&gt;     NA
4 4 Subject_1 11.000578 3.702009 3.296291     &lt;NA&gt;     NA
5 5 Subject_1 14.334104 3.686186 3.282202     &lt;NA&gt;     NA
6 6 Subject_1 17.667630 3.712768 3.305871     &lt;NA&gt;     NA</code></pre>
</div>
</div>
<p>Our dataframe consists of several easily interpretable columns. <strong>Time</strong> represents elapsed time in milliseconds, <strong>Subject</strong> identifies the participant, and <strong>Events</strong> indicates when and which stimuli were presented. <strong>TrialN</strong> tracks the trial number, while <strong>PupilL</strong> and <strong>PupilR</strong> measure pupil dilation for the left and right eyes, respectively, in millimeters.</p>
<p>Let‚Äôs plot the data! Visualizing it first is always a crucial step as it provides an initial understanding of its structure and key patterns.</p>
<div class="cell" data-warnings="false">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">Raw_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Time</span>, y <span class="op">=</span> <span class="va">PupilR</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">PupilR</span>, color <span class="op">=</span> <span class="st">'Pupil Right'</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">PupilL</span>, color <span class="op">=</span> <span class="st">'Pupil Left'</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>data <span class="op">=</span> <span class="va">Raw_data</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">Events</span><span class="op">)</span><span class="op">)</span> , <span class="fu">aes</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">Time</span>, color <span class="op">=</span> <span class="va">Events</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="st">'dashed'</span><span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">Subject</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">35</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ylim</span><span class="op">(</span><span class="fl">1</span>,<span class="fl">6</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Pupil Right'</span> <span class="op">=</span> <span class="st">'#4A6274'</span>, <span class="st">'Pupil Left'</span> <span class="op">=</span> <span class="st">'#E2725A'</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'bottom'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>color <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lwd <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Make legend lines thicker</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><a href="PupillometryPreprocessing_files/figure-html/PlotRaw-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="PupillometryPreprocessing_files/figure-html/PlotRaw-1.png" class="img-fluid figure-img" width="1920"></a></p>
</figure>
</div>
</div>
</div>
</section><section id="prepare-the-data" class="level2"><h2 class="anchored" data-anchor-id="prepare-the-data">Prepare the data</h2>
<p>Now that we‚Äôve visualized the data, you‚Äôve probably noticed two things:</p>
<ol type="1">
<li><p><strong>So many events!</strong> That‚Äôs intentional ‚Äî it‚Äôs better to have too many triggers than miss something important. But don‚Äôt worry, for our pupil dilation analysis, we only care about two key events: <strong>Circle</strong> and <strong>Square</strong> (check the paradigm intro if you need a refresher on why that is).</p></li>
<li><p><strong>Single-sample events!</strong> Like in most studies, events are marked at a single time point (when the stimulus is presented). But PupilometryR needs a different structure ‚Äî it expects the event value to be repeated for every row while the event is happening.</p></li>
</ol>
<p>So, how do we fix this? First, let‚Äôs isolate the rows in our dataframe where the events are <strong>Circle</strong> or <strong>Square</strong>. We start by creating a list of the events we care about, then use it to filter our dataframe and keep only the rows related to those events in a new dataframe called Events</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Events_to_keep</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Circle'</span>,<span class="st">'Square'</span><span class="op">)</span></span>
<span><span class="va">Events</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">Raw_data</span>, <span class="va">Events</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">Events_to_keep</span><span class="op">)</span> <span class="co"># filter data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">Events</span><span class="op">)</span> <span class="co"># database peak</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      X   Subject       Time   PupilL   PupilR Events TrialN
1   221 Subject_1   734.3757       NA       NA Circle      1
2  2552 Subject_1  8504.8248 3.288117 2.927758 Square      2
3  4883 Subject_1 16275.2739 2.926076 2.605395 Circle      3
4  7215 Subject_1 24049.0565 3.463782 3.084172 Circle      4
5  9546 Subject_1 31819.5055 3.433078 3.056833 Square      5
6 11877 Subject_1 39589.9546 3.890758 3.464353 Circle      6</code></pre>
</div>
</div>
<p>Perfect! Now onto the second point: we need to repeat the events we just selected for the entire duration we want to analyze. But what‚Äôs this duration? We want to cover the full cue presentation (2 seconds), plus an extra 0.5 seconds before the stimulus appears. Why? This pre-stimulus period will serve as our baseline, which we‚Äôll use later in the analysis.</p>
<p>So, let‚Äôs define how much time to include before and after the stimulus. We‚Äôll also set the framerate of our data (<strong>300Hz</strong>) and create a time vector that starts from the pre-stimulus period and continues in steps of 1/Hz, with a total length equal to Pre_stim + Post_stim. In addition we also create a copy of our raw data called Trial_data. We do this so the original data stays intact, and all our edits happen on the copy</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Settings to cut events</span></span>
<span><span class="va">Pre_stim</span> <span class="op">=</span> <span class="fl">100</span> <span class="co"># pre stimulus time</span></span>
<span><span class="va">Post_stim</span> <span class="op">=</span> <span class="fl">2000</span> <span class="co"># post stimulus time</span></span>
<span><span class="va">Fs</span> <span class="op">=</span> <span class="fl">300</span> <span class="co"># framerate</span></span>
<span></span>
<span><span class="va">Time</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="op">-</span><span class="va">Pre_stim</span>, by<span class="op">=</span><span class="fl">1000</span><span class="op">/</span><span class="va">Fs</span>, length.out <span class="op">=</span> <span class="op">(</span><span class="va">Pre_stim</span><span class="op">+</span><span class="va">Post_stim</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span><span class="op">*</span><span class="fl">300</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="co"># time vector</span></span>
<span></span>
<span><span class="co"># create copy of the raw data</span></span>
<span><span class="va">Trial_data</span> <span class="op">=</span> <span class="va">Raw_data</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here‚Äôs where the magic happens. We loop through each event listed in our <strong>Events</strong> dataframe. Each row in Events corresponds to a specific event (like a ‚ÄúCircle‚Äù or ‚ÄúSquare‚Äù cue) that occurred for a specific subject during a specific trial.</p>
<p>For each event, we extract three key details:</p>
<ul>
<li><p><strong>Subject</strong> (to know which participant the event is for)</p></li>
<li><p><strong>Event</strong> (to know if it‚Äôs a Circle or Square cue)</p></li>
<li><p><strong>TrialN</strong> (to know which trial this event is part of)</p></li>
</ul>
<p>Next, we identify the rows of interest in our dataframe. We look for rows where the Subject matches the current participant, and the Time falls within the window from Pre_stim to Post_stim relative to the event‚Äôs start.</p>
<p>Finally, we use these identified rows to add the event information. The Time, Event, and TrialN values are repeated across all the rows in this window, ensuring every row in the event window is properly labeled.</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Loop for each event of each subject</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">trial</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">Events</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>    <span class="co"># Extract the information</span></span>
<span>    <span class="va">Sub</span> <span class="op">=</span> <span class="va">Events</span><span class="op">[</span><span class="va">trial</span>, <span class="st">'Subject'</span><span class="op">]</span></span>
<span>    <span class="va">Event</span> <span class="op">=</span> <span class="va">Events</span><span class="op">[</span><span class="va">trial</span>, <span class="st">'Events'</span><span class="op">]</span></span>
<span>    <span class="va">TrialN</span> <span class="op">=</span> <span class="va">Events</span><span class="op">[</span><span class="va">trial</span>, <span class="st">'TrialN'</span><span class="op">]</span></span>
<span>    <span class="va">Onset</span> <span class="op">=</span> <span class="va">Events</span><span class="op">[</span><span class="va">trial</span>, <span class="st">'Time'</span><span class="op">]</span></span>
<span></span>
<span>    </span>
<span>    <span class="co"># Find the rows to update based on subject and time</span></span>
<span>    <span class="va">rows_to_update</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">Trial_data</span><span class="op">$</span><span class="va">Subject</span> <span class="op">==</span> <span class="va">Sub</span> <span class="op">&amp;</span></span>
<span>                           <span class="va">Trial_data</span><span class="op">$</span><span class="va">Time</span> <span class="op">&gt;=</span> <span class="op">(</span><span class="va">Onset</span> <span class="op">-</span> <span class="va">Pre_stim</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>                           <span class="va">Trial_data</span><span class="op">$</span><span class="va">Time</span> <span class="op">&lt;</span> <span class="op">(</span><span class="va">Onset</span> <span class="op">+</span> <span class="va">Post_stim</span><span class="op">)</span><span class="op">)</span></span>
<span>   </span>
<span>    <span class="co"># Repeat the values of interest for all the rows</span></span>
<span>    <span class="va">Trial_data</span><span class="op">[</span><span class="va">rows_to_update</span>, <span class="st">'Time'</span><span class="op">]</span> <span class="op">=</span> <span class="va">Time</span></span>
<span>    <span class="va">Trial_data</span><span class="op">[</span><span class="va">rows_to_update</span>, <span class="st">'Events'</span><span class="op">]</span> <span class="op">=</span> <span class="va">Event</span></span>
<span>    <span class="va">Trial_data</span><span class="op">[</span><span class="va">rows_to_update</span>, <span class="st">'TrialN'</span><span class="op">]</span> <span class="op">=</span> <span class="va">TrialN</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Perfect! We‚Äôve successfully extended the event information backward and forward based on our Pre_stim and Post_stim windows. Now, it‚Äôs time to clean things up.</p>
<p>Since we only care about the rows that are part of our trial of interest, we‚Äôll remove all the rows that don‚Äôt belong to these event windows. This will leave us with a clean, focused dataset that only contains the data relevant to our analysis.</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Trial_data</span> <span class="op">=</span> <span class="va">Trial_data</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">Events</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">Events_to_keep</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Very good job reaching to this point!! if you believe it or not this was the hardest part!! We have now our different dataset!! let‚Äôs take a look:</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">Trial_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Time</span>, y <span class="op">=</span> <span class="va">PupilR</span>, group <span class="op">=</span> <span class="va">TrialN</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">PupilR</span>, color <span class="op">=</span> <span class="st">'Pupil Right'</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">PupilL</span>, color <span class="op">=</span> <span class="st">'Pupil Left'</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="st">'dashed'</span>, color <span class="op">=</span> <span class="st">'black'</span>, lwd <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">Subject</span><span class="op">)</span> <span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ylim</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">6</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Pupil Right'</span> <span class="op">=</span> <span class="st">'#4A6274'</span>, <span class="st">'Pupil Left'</span> <span class="op">=</span> <span class="st">'#E2725A'</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">35</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">'bottom'</span>, </span>
<span>    legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>color <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lwd <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><a href="PupillometryPreprocessing_files/figure-html/PlotEvents-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="PupillometryPreprocessing_files/figure-html/PlotEvents-1.png" class="img-fluid figure-img" width="12000"></a></p>
</figure>
</div>
</div>
</div>
<section id="make-pupillometryr-data" class="level3"><h3 class="anchored" data-anchor-id="make-pupillometryr-data">Make pupillometryR data</h3>
<p>Ok, now it‚Äôs time to start working with <strong>PupillometryR</strong>! üéâ</p>
<p>In the previous steps, we changed our event structure, and you might be wondering ‚Äî why all that effort? Well, it‚Äôs because PupillometryR needs the data in this specific format to do its magic. To get started, we‚Äôll pass our dataframe to the <code>make_pupillometryr_data()</code> function. If you‚Äôre already thinking, ‚ÄúOh no, not another weird object type that‚Äôs hard to work with!‚Äù ‚Äî don‚Äôt worry! The good news is that the main object it creates is just a regular dataframe. That means we can still interact with like we‚Äôre used to. This makes the pre-processing steps much less frustrating. Let‚Äôs get started!</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Trial_data[Trial_data$Subject == 'Subject_1' &amp; Trial_data$TrialN==1,]$PupilL = NA</span></span>
<span><span class="co"># Trial_data[Trial_data$Subject == 'Subject_1' &amp; Trial_data$TrialN==1,]$PupilR = NA</span></span>
<span><span class="co"># Trial_data[Trial_data$Subject == 'Subject_4' &amp; Trial_data$TrialN==1,]$PupilL = NA</span></span>
<span><span class="co"># Trial_data[Trial_data$Subject == 'Subject_4' &amp; Trial_data$TrialN==1,]$PupilR = NA</span></span>
<span></span>
<span><span class="va">PupilR_data</span> <span class="op">=</span> <span class="fu">make_pupillometryr_data</span><span class="op">(</span>data <span class="op">=</span> <span class="va">Trial_data</span>,</span>
<span>                                 subject <span class="op">=</span> <span class="va">Subject</span>,</span>
<span>                                 trial <span class="op">=</span> <span class="va">TrialN</span>,</span>
<span>                                 time <span class="op">=</span> <span class="va">Time</span>,</span>
<span>                                 condition <span class="op">=</span> <span class="va">Events</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here, we‚Äôre simply using the <strong><code>make_pupillometryr_data()</code></strong> function to pass in our data and specify which columns contain the key information. This tells PupillometryR where to find the crucial details, like subject IDs, events, and pupil measurements, so it knows how to structure and process the data properly.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you have extra columns that you want to keep in your <strong>PupillometryR</strong> data during preprocessing, you can pass them as a list using the <strong><code>other = c(OtherColumn1, OtherColumn2)</code></strong> argument. This allows you to keep these additional columns alongside your main data throughout most of the preprocessing steps.</p>
<p>But here‚Äôs a heads-up ‚Äî not all functions can keep these extra columns every time. For example, downsampling may not retain them since it reduces the number of rows, and it‚Äôs not always clear how to summarize extra columns. So, keep that in mind as you plan your analysis!</p>
</div>
</div>
<section id="plot" class="level4"><h4 class="anchored" data-anchor-id="plot">Plot</h4>
<p>One cool feature of the data created using <strong><code>make_pupillometryr_data()</code></strong> is that it comes with a simple, built-in <code>plot</code> function. This makes it super easy to visualize your data without needing to write tons of code. The plot function works by averaging the data over the <code>group</code> variable. So we can group over subject or condition. Here we use the <code>group</code> variable to focus on the <strong>condition</strong> and average over the subjec.</p>
<p>In this example, we‚Äôre plotting the PupilL (left pupil) data, grouped by condition. The <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> function is actually just a ggplot2 wrapper, which means you can customize to a certain extent like any other ggplot. That‚Äôs why we can add elements to it, like <strong><code>theme_bw()</code></strong>, which gives the plot a cleaner, black-and-white look. Give it a go without adding anything and then learn to customize it!!</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Pro tip!</strong> If you want more control over your plots, you can always use ggplot2. Remember, the Pupil data is just a regular dataframe, so you can plot it in any way you like!</p>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">PupilR_data</span>, pupil <span class="op">=</span> <span class="va">PupilL</span>, group <span class="op">=</span> <span class="st">'condition'</span>, geom <span class="op">=</span> <span class="st">'line'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">45</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">'bottom'</span>, </span>
<span>    legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>color <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lwd <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><a href="PupillometryPreprocessing_files/figure-html/Pupilplot-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="PupillometryPreprocessing_files/figure-html/Pupilplot-1.png" class="img-fluid figure-img" width="3840"></a></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>In this tutorial, we‚Äôll use two methods to plot our data. We‚Äôll use the PupillometryR plot to visualize the average pupil response by condition, and we‚Äôll also use ggplot to manually plot our data. Both approaches are valid and offer unique benefits.</p>
<p>The PupillometryR plot provides a quick overview by automatically averaging pupil responses across condition levels, making it ideal for high-level trend visualization. On the other hand, ggplot gives you full control to visualize specific details or customize every aspect of the plot, allowing for deeper insights and flexibility.</p>
</div>
</div>
</section></section></section><section id="pre-processing" class="level2"><h2 class="anchored" data-anchor-id="pre-processing">Pre-processing</h2>
<p>Now that we have our pupillometry data in the required format we can actually start the pre-processing!!</p>
<section id="regress" class="level3"><h3 class="anchored" data-anchor-id="regress">Regress</h3>
<p>The first step is to regress <strong>PupilL</strong> against <strong>PupilR</strong> (and vice versa) using a simple linear regression. This corrects small inconsistencies in pupil data caused by noise. The regression is done separately for each participant, trial, and time point, ensuring smoother and more consistent pupil dilation measurements.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Regressed_data</span> <span class="op">&lt;-</span> <span class="fu">regress_data</span><span class="op">(</span>data <span class="op">=</span> <span class="va">PupilR_data</span>,</span>
<span>                                pupil1 <span class="op">=</span> <span class="va">PupilL</span>,</span>
<span>                                pupil2 <span class="op">=</span> <span class="va">PupilR</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in `mutate()`:
‚Ñπ In argument: `pupil1newkk = .predict_right(PupilL, PupilR)`.
‚Ñπ In group 1: `Subject = "Subject_1"`, `TrialN = 1`, `Events = "Circle"`.
Caused by error in `lm.fit()`:
! 0 (non-NA) cases</code></pre>
</div>
</div>
<p><strong>Pwa pwa pwaaaaa‚Ä¶!!</strong>ü§¶‚Äç‚ôÇÔ∏è We got an error!</p>
<p>What‚Äôs it saying? It‚Äôs telling us that one of the trials is completely full of <strong>NAs</strong>, and since there‚Äôs no data to work with, the function fails. This happens <strong>a lot</strong> when testing infants ‚Äî they don‚Äôt always do what we expect, like watching the screen. Instead, they move around or look away.</p>
<p>We‚Äôll deal with missing data properly later, but for now, we need a quick fix. What can we do? We can simply drop any trials where both pupils (PupilL and PupilR) are entirely NA. This way, we avoid errors and keep the analysis moving.</p>
<p>So let‚Äôs filter our data and then redo the last two steps (make PupilR_data and then regress data)</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Filter the trial data</span></span>
<span><span class="va">Trial_data</span> <span class="op">&lt;-</span> <span class="va">Trial_data</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">Subject</span>, <span class="va">TrialN</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># group by Subject and TrialN</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">PupilL</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span> <span class="va">PupilR</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># filter out if both PupilR and PupilL are all NA</span></span>
<span>    <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span>  <span class="co"># Remove grouping</span></span>
<span></span>
<span><span class="co"># Make pupilloemtryR data</span></span>
<span><span class="va">PupilR_data</span> <span class="op">=</span> <span class="fu">make_pupillometryr_data</span><span class="op">(</span>data <span class="op">=</span> <span class="va">Trial_data</span>,</span>
<span>                                 subject <span class="op">=</span> <span class="va">Subject</span>,</span>
<span>                                 trial <span class="op">=</span> <span class="va">TrialN</span>,</span>
<span>                                 time <span class="op">=</span> <span class="va">Time</span>,</span>
<span>                                 condition <span class="op">=</span> <span class="va">Events</span><span class="op">)</span></span>
<span><span class="co"># Regress data</span></span>
<span><span class="va">Regressed_data</span> <span class="op">&lt;-</span> <span class="fu">regress_data</span><span class="op">(</span>data <span class="op">=</span> <span class="va">PupilR_data</span>,</span>
<span>                               pupil1 <span class="op">=</span> <span class="va">PupilL</span>,</span>
<span>                                pupil2 <span class="op">=</span> <span class="va">PupilR</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And now everything worked!! Perfect!</p>
</section><section id="mean-pupil" class="level3"><h3 class="anchored" data-anchor-id="mean-pupil">Mean pupil</h3>
<p>As the next steps we will average the two pupil signals. This will create a new variable called mean_pupil</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Mean_data</span> <span class="op">&lt;-</span> <span class="fu">calculate_mean_pupil_size</span><span class="op">(</span>data <span class="op">=</span> <span class="va">Regressed_data</span>, </span>
<span>                                       pupil1 <span class="op">=</span> <span class="va">PupilL</span>, </span>
<span>                                       pupil2 <span class="op">=</span> <span class="va">PupilR</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">Mean_data</span>, pupil <span class="op">=</span> <span class="va">mean_pupil</span>, group <span class="op">=</span> <span class="st">'condition'</span>, geom <span class="op">=</span> <span class="st">'line'</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">45</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">'bottom'</span>, </span>
<span>    legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>color <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lwd <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><a href="PupillometryPreprocessing_files/figure-html/MeanData-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="PupillometryPreprocessing_files/figure-html/MeanData-1.png" class="img-fluid figure-img" width="3840"></a></p>
</figure>
</div>
</div>
</div>
</section><section id="lowpass" class="level3"><h3 class="anchored" data-anchor-id="lowpass">Lowpass</h3>
<p>Now that we have a single pupil signal, we can move on to filtering it. The goal here is to remove fast noise and fluctuations that aren‚Äôt relevant to our analysis. Why? Because we know that pupil dilation is a slow physiological signal, and those rapid changes are likely just noise from blinks, eye movements, or measurement errors. By filtering out these fast fluctuations, we can focus on the meaningful changes in pupil dilation that matter for our analysis.</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">filtered_data</span> <span class="op">&lt;-</span> <span class="fu">filter_data</span><span class="op">(</span>data <span class="op">=</span> <span class="va">Mean_data</span>,</span>
<span>                             pupil <span class="op">=</span> <span class="va">mean_pupil</span>,</span>
<span>                             filter <span class="op">=</span> <span class="st">'median'</span>,</span>
<span>                             degree <span class="op">=</span> <span class="fl">11</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">filtered_data</span>, pupil <span class="op">=</span> <span class="va">mean_pupil</span>, group <span class="op">=</span> <span class="st">'condition'</span>, geom <span class="op">=</span> <span class="st">'line'</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">45</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">'bottom'</span>, </span>
<span>    legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>color <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lwd <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><a href="PupillometryPreprocessing_files/figure-html/Lowpass-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="PupillometryPreprocessing_files/figure-html/Lowpass-1.png" class="img-fluid figure-img" width="3840"></a></p>
</figure>
</div>
</div>
</div>
<p>There are different ways to filter the data in PupillometryR we suggest you check the actual package website and make decision based on your data (<a href="http://samforbes.me/PupillometryR/reference/filter_data.html"><code>filter_data</code></a>). Here we use a median filter based on a 11 sample window.</p>
</section><section id="downsample" class="level3"><h3 class="anchored" data-anchor-id="downsample">Downsample</h3>
<p>As mentioned above, Pupil dilation is a slow signal, so 20Hz is enough ‚Äî no need for 300Hz. Downsampling reduces file size, speeds up processing, and naturally smooths the signal by filtering out high-frequency noise, all while preserving the key information we need for analysis. To downsample to 20Hz, we‚Äôll set the timebin size to 50 ms (since 1/20 = 0.05 seconds = 50 ms) and calculate the median for each time bin.</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">NewHz</span> <span class="op">=</span> <span class="fl">20</span></span>
<span><span class="va">timebinSize</span> <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="va">NewHz</span></span>
<span></span>
<span><span class="va">Downsampled_data</span> <span class="op">&lt;-</span> <span class="fu">downsample_time_data</span><span class="op">(</span>data <span class="op">=</span> <span class="va">filtered_data</span>,</span>
<span>                              pupil <span class="op">=</span> <span class="va">mean_pupil</span>,</span>
<span>                              timebin_size <span class="op">=</span> <span class="va">timebinSize</span>,</span>
<span>                              option <span class="op">=</span> <span class="st">'median'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">Downsampled_data</span>, pupil <span class="op">=</span> <span class="va">mean_pupil</span>, group <span class="op">=</span> <span class="st">'condition'</span>, geom <span class="op">=</span> <span class="st">'line'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">45</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">'bottom'</span>, </span>
<span>    legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>color <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lwd <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><a href="PupillometryPreprocessing_files/figure-html/Downsample-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="PupillometryPreprocessing_files/figure-html/Downsample-1.png" class="img-fluid figure-img" width="3840"></a></p>
</figure>
</div>
</div>
</div>
</section><section id="trial-rejection" class="level3"><h3 class="anchored" data-anchor-id="trial-rejection">Trial Rejection</h3>
<p>Now that our data is smaller and smoother, it‚Äôs a good time to take a look at it. It doesn‚Äôt make sense to keep trials that are mostly missing values, nor does it make sense to keep participants with very few good trials.</p>
<p>While you might already have info on trial counts and participant performance from other sources (like video coding), PupillometryR has a super handy function to check this directly. This way, you can quickly see how many valid trials each participant has and decide which ones to keep or drop.</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Missing_data</span> <span class="op">&lt;-</span> <span class="fu">calculate_missing_data</span><span class="op">(</span><span class="va">Downsampled_data</span>,</span>
<span>                                       <span class="va">mean_pupil</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">Missing_data</span>, n<span class="op">=</span><span class="fl">20</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 20 √ó 3
   Subject   TrialN Missing
   &lt;chr&gt;      &lt;int&gt;   &lt;dbl&gt;
 1 Subject_1      2  0.111 
 2 Subject_1      3  0.0159
 3 Subject_1      4  0.130 
 4 Subject_1      5  0.0541
 5 Subject_1      6  0     
 6 Subject_1      7  0.141 
 7 Subject_1      8  0.132 
 8 Subject_1      9  0     
 9 Subject_1     10  0     
10 Subject_2      1  0     
11 Subject_2      2  0     
12 Subject_2      3  0.107 
13 Subject_2      4  0.124 
14 Subject_2      5  0     
15 Subject_2      6  0.0954
16 Subject_2      7  0     
17 Subject_2      8  0.141 
18 Subject_2      9  0.0922
19 Subject_2     10  0.119 
20 Subject_3      1  0.107 </code></pre>
</div>
</div>
<p>This gives us a new dataframe that shows the amount of missing data for each subject and each trial. While we could manually decide which trials and subjects to keep or remove, PupillometryR makes it easier with the <strong><code>clean_missing_data()</code></strong> function.</p>
<p>This function lets you set two % thresholds ‚Äî one for trials and one for subjects. Here, we‚Äôll set it to reject trials with more than 25% missing data (keep at least 75% of the data) and reject subjects with more than 25% missing data. This way, we ensure our analysis is based on clean, high-quality data.</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Clean_data</span> <span class="op">&lt;-</span> <span class="fu">clean_missing_data</span><span class="op">(</span><span class="va">Downsampled_data</span>,</span>
<span>                                 pupil <span class="op">=</span> <span class="va">mean_pupil</span>,</span>
<span>                                 trial_threshold <span class="op">=</span> <span class="fl">.75</span>,</span>
<span>                                 subject_trial_threshold <span class="op">=</span> <span class="fl">.75</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note that this function calculates the percentage of missing trials based only on the trials present in the dataframe. For example, if a participant only completed one trial (and watched it perfectly) before the session had to stop, the percentage would be calculated on that single trial, and the participant wouldn‚Äôt be rejected.</p>
<p>If you have more complex conditions for excluding participants (e.g., based on total expected trials or additional criteria), you‚Äôll need to handle this manually to ensure subjects are dropped appropriately.</p>
</div>
</div>
</section><section id="fill-the-signal" class="level3"><h3 class="anchored" data-anchor-id="fill-the-signal">Fill the signal</h3>
<p>Now our data is clean, but‚Ä¶ while the average signal for each condition looks smooth (as seen in our plots), the data for each individual participant is still noisy. We can still spot blinks and missing data in the signal.</p>
<p>To handle this, we‚Äôll use interpolation to fill in the missing points. Interpolation ‚Äúconnects the dots‚Äù between gaps, creating a more continuous and cleaner signal. This step is crucial because large chunks of missing data can distort our analysis, and interpolation allows us to retain more usable data from each participant.</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">Clean_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Time</span>, y <span class="op">=</span> <span class="va">mean_pupil</span>, group <span class="op">=</span> <span class="va">TrialN</span>, color<span class="op">=</span> <span class="va">Events</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span> lwd <span class="op">=</span><span class="fl">1.2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, linetype<span class="op">=</span> <span class="st">'dashed'</span>, color <span class="op">=</span> <span class="st">'black'</span>, lwd <span class="op">=</span><span class="fl">1.2</span><span class="op">)</span><span class="op">+</span></span>
<span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">Subject</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ylim</span><span class="op">(</span><span class="fl">1</span>,<span class="fl">6</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">45</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">'bottom'</span>, </span>
<span>    legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>y <span class="op">=</span> <span class="st">'Pupil Size'</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>color <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lwd <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><a href="PupillometryPreprocessing_files/figure-html/PlotBlink-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="PupillometryPreprocessing_files/figure-html/PlotBlink-1.png" class="img-fluid figure-img" width="3840"></a></p>
</figure>
</div>
</div>
</div>
<p>So to remove these missing values we can interpolate our data. Interpolating is easy with pupillometryR we can simply:</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Int_data</span> <span class="op">&lt;-</span> <span class="fu">interpolate_data</span><span class="op">(</span>data <span class="op">=</span> <span class="va">Clean_data</span>,</span>
<span>                             pupil <span class="op">=</span> <span class="va">mean_pupil</span>,</span>
<span>                             type <span class="op">=</span> <span class="st">'linear'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">Int_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Time</span>, y <span class="op">=</span> <span class="va">mean_pupil</span>, group <span class="op">=</span> <span class="va">TrialN</span>, color <span class="op">=</span> <span class="va">Events</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>lwd <span class="op">=</span><span class="fl">1.2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, linetype<span class="op">=</span> <span class="st">'dashed'</span>, color <span class="op">=</span> <span class="st">'black'</span>, lwd <span class="op">=</span><span class="fl">1.2</span><span class="op">)</span><span class="op">+</span></span>
<span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">Subject</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ylim</span><span class="op">(</span><span class="fl">1</span>,<span class="fl">6</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">45</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">'bottom'</span>, </span>
<span>    legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>y <span class="op">=</span> <span class="st">'Pupil Size'</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>color <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lwd <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><a href="PupillometryPreprocessing_files/figure-html/WrongInterpolation-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="PupillometryPreprocessing_files/figure-html/WrongInterpolation-1.png" class="img-fluid figure-img" width="3840"></a></p>
</figure>
</div>
</div>
</div>
<p><strong>Done!!</strong> Well, you‚Äôve probably noticed something strange‚Ä¶ When there‚Äôs a blink, the pupil signal can rapidly decrease until it‚Äôs completely missing. Right now, this drop gets interpolated, and the result is a weird, unrealistic curve where the signal dips sharply and then smoothly recovers. This makes our data look horrible! üò©</p>
<p><strong>Let‚Äôs fix it!</strong></p>
<p>To do this, we‚Äôll use PupillometryR‚Äôs blink detection functions. There are two main ways to detect blinks:</p>
<ol type="1">
<li><p><a href="http://samforbes.me/PupillometryR/reference/detect_blinks_by_size.html"><strong>Based on size</strong></a> ‚Äî detects pupil size.</p></li>
<li><p><a href="http://samforbes.me/PupillometryR/reference/detect_blinks_by_velocity.html"><strong>Based on velocity</strong></a> ‚Äî detects rapid changes in pupil size (which happens during blinks).</p></li>
</ol>
<p>Here, we‚Äôll use detection by velocity. We set a velocity threshold to detect when the pupil size changes too quickly. To ensure we capture the full blink, we use <code>extend_forward</code> and <code>extend_back</code> to expand the blink window, including the fast decrease in pupil size. The key idea is to make the entire blink period NA, not just the moment the pupil disappears. This prevents interpolation from creating unrealistic artifacts. When we interpolate, the process skips over the entire blink period, resulting in a cleaner, more natural signal.</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Blink_data</span> <span class="op">=</span> <span class="fu">detect_blinks_by_velocity</span><span class="op">(</span></span>
<span>    <span class="va">Clean_data</span>,</span>
<span>    <span class="va">mean_pupil</span>,</span>
<span>    threshold <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>    extend_forward <span class="op">=</span> <span class="fl">50</span>,</span>
<span>    extend_back <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">Blink_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Time</span>, y <span class="op">=</span> <span class="va">mean_pupil</span>, group <span class="op">=</span> <span class="va">TrialN</span>, color<span class="op">=</span><span class="va">Events</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>lwd <span class="op">=</span><span class="fl">1.2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, linetype<span class="op">=</span> <span class="st">'dashed'</span>, color <span class="op">=</span> <span class="st">'black'</span>, lwd <span class="op">=</span><span class="fl">1.2</span><span class="op">)</span><span class="op">+</span></span>
<span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">Subject</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ylim</span><span class="op">(</span><span class="fl">1</span>,<span class="fl">6</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">45</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">'bottom'</span>, </span>
<span>    legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>y <span class="op">=</span> <span class="st">'Pupil Size'</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>color <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lwd <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><a href="PupillometryPreprocessing_files/figure-html/BlinkRemoval-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="PupillometryPreprocessing_files/figure-html/BlinkRemoval-1.png" class="img-fluid figure-img" width="3840"></a></p>
</figure>
</div>
</div>
</div>
<p>See !! now the rapid shrinking disappeared and we can now interpolate</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Int_data</span> <span class="op">&lt;-</span> <span class="fu">interpolate_data</span><span class="op">(</span>data <span class="op">=</span> <span class="va">Blink_data</span>,</span>
<span>                             pupil <span class="op">=</span> <span class="va">mean_pupil</span>,</span>
<span>                             type <span class="op">=</span> <span class="st">'linear'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">Int_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Time</span>, y <span class="op">=</span> <span class="va">mean_pupil</span>, group <span class="op">=</span> <span class="va">TrialN</span>, color<span class="op">=</span><span class="va">Events</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>lwd <span class="op">=</span><span class="fl">1.2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, linetype<span class="op">=</span> <span class="st">'dashed'</span>, color <span class="op">=</span> <span class="st">'black'</span>, lwd <span class="op">=</span><span class="fl">1.2</span><span class="op">)</span><span class="op">+</span></span>
<span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">Subject</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ylim</span><span class="op">(</span><span class="fl">1</span>,<span class="fl">6</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">45</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">'bottom'</span>, </span>
<span>    legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>y <span class="op">=</span> <span class="st">'Pupil Size'</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>color <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lwd <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><a href="PupillometryPreprocessing_files/figure-html/Interpolation2-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="PupillometryPreprocessing_files/figure-html/Interpolation2-1.png" class="img-fluid figure-img" width="3840"></a></p>
</figure>
</div>
</div>
</div>
<p>Look how beautiful our signal is now!! üòç Good job!!!</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p>It‚Äôs not always the case that blinks will have a rapid drop in pupil size followed by missing values. Sometimes, you‚Äôll just get missing values straight away. This can depend on the eye tracker, sampling rate, and even the population you‚Äôre testing (like infants who might look away suddenly). Because of this, blink detection may not always be necessary. The best approach is to check your data before deciding. And how do you check it? Plotting! Plotting your signal is the best way to see if blinks are causing rapid drops or if you‚Äôre just dealing with missing data. Let the data guide your decisions.</p>
</div>
</div>
</section><section id="baseline-correction" class="level3"><h3 class="anchored" data-anchor-id="baseline-correction">Baseline Correction</h3>
<p>Good job getting this far!! We‚Äôre now at the final step of our pre-processing: baseline correction.</p>
<p>Baseline correction helps remove variability between trials and participants, like differences in baseline pupil size caused by individual differences, fatigue, or random fluctuations. By doing this, we can focus only on the variability caused by our paradigm. This step ensures that any changes we see in pupil size are truly driven by the experimental conditions, not irrelevant noise. Let‚Äôs get it done!</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Base_data</span> <span class="op">&lt;-</span> <span class="fu">baseline_data</span><span class="op">(</span>data <span class="op">=</span> <span class="va">Int_data</span>,</span>
<span>                           pupil <span class="op">=</span> <span class="va">mean_pupil</span>,</span>
<span>                           start <span class="op">=</span> <span class="op">-</span><span class="fl">100</span>,</span>
<span>                           stop <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let‚Äôs plot it to see what baseline correction is actually doing!! We will plot both the average signal using the <code>plot</code> function (with some addition inforamtion about color and theme) and using ggplot to plot the data for each subject separately.</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">One</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">Base_data</span>, pupil <span class="op">=</span> <span class="va">mean_pupil</span>, group <span class="op">=</span> <span class="st">'condition'</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">45</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'none'</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">Two</span> <span class="op">=</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">Base_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Time</span>, y <span class="op">=</span> <span class="va">mean_pupil</span>, group <span class="op">=</span> <span class="va">TrialN</span>, color <span class="op">=</span> <span class="va">Events</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>lwd <span class="op">=</span><span class="fl">1.2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, linetype<span class="op">=</span> <span class="st">'dashed'</span>, color <span class="op">=</span> <span class="st">'black'</span>, lwd <span class="op">=</span><span class="fl">1.2</span><span class="op">)</span><span class="op">+</span></span>
<span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">Subject</span><span class="op">)</span><span class="op">+</span></span>
<span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">45</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">'bottom'</span>, </span>
<span>    legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>y <span class="op">=</span> <span class="st">'Pupil Size'</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>color <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lwd <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Using patchwork to put the plot toghether</span></span>
<span><span class="va">One</span> <span class="op">/</span> <span class="va">Two</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><a href="PupillometryPreprocessing_files/figure-html/FinalPlot-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11"><img src="PupillometryPreprocessing_files/figure-html/FinalPlot-1.png" class="img-fluid figure-img" width="3840"></a></p>
</figure>
</div>
</div>
</div>
</section><section id="save-and-analysis" class="level3"><h3 class="anchored" data-anchor-id="save-and-analysis">Save and analysis</h3>
<p>This tutorial will not cover the analysis of pupil dilation. We‚Äôll stop here since, after baseline correction, the data is ready to be explored and analyzed. From this point on, we‚Äôll shift from <strong>pre-processing</strong> to <strong>analysis</strong>, so it‚Äôs a good idea to save the data as a simple <em>.csv</em> file for easy access and future use.</p>
<div class="cell" data-eco="false">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">Base_data</span>,<span class="st">"..\\..\\resources\\Pupillometry\\ProcessedPupilData.csv"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are multiple ways to analyze pupil data, and we‚Äôll show you some of our favorite methods in a dedicated tutorial: <strong>Analyze Pupil Dilation</strong>.</p>
</section></section><section id="all-code" class="level2"><h2 class="anchored" data-anchor-id="all-code">All code</h2>
<p>Here below we report the whole code we went trough this tutorial as an unique scrit to make it easier for you to copy and explore it in it‚Äôs entirety. We</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting and Libraries -----------------------------------------------------------------</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(PupillometryR)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Read Data -----------------------------------------------------------------</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>Raw_data <span class="ot">=</span> <span class="fu">read.csv</span>(<span class="st">"..</span><span class="sc">\\</span><span class="st">..</span><span class="sc">\\</span><span class="st">resources</span><span class="sc">\\</span><span class="st">Pupillometry</span><span class="sc">\\</span><span class="st">PupilData.csv"</span>)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Raw_data)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot Raw Data -----------------------------------------------------------------</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(Raw_data, <span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> PupilR)) <span class="sc">+</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> PupilR, <span class="at">color =</span> <span class="st">'Pupil Right'</span>), <span class="at">lwd =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> PupilL, <span class="at">color =</span> <span class="st">'Pupil Left'</span>), <span class="at">lwd =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">data =</span> Raw_data <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Events)), <span class="fu">aes</span>(<span class="at">xintercept =</span> Time, <span class="at">color =</span> Events), <span class="at">linetype =</span> <span class="st">'dashed'</span>) <span class="sc">+</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Subject) <span class="sc">+</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">35</span>) <span class="sc">+</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">1</span>, <span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">'Pupil Right'</span> <span class="ot">=</span> <span class="st">'#4A6274'</span>, <span class="st">'Pupil Left'</span> <span class="ot">=</span> <span class="st">'#E2725A'</span>)) <span class="sc">+</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>) <span class="sc">+</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">lwd =</span> <span class="dv">20</span>)))</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare Data -----------------------------------------------------------------</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a><span class="do">## Extract Events -----------------------------------------------------------------</span></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>Events_to_keep <span class="ot">=</span> <span class="fu">c</span>(<span class="st">'Circle'</span>,<span class="st">'Square'</span>)</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>Events <span class="ot">=</span> <span class="fu">filter</span>(Raw_data, Events <span class="sc">%in%</span> Events_to_keep)</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Events)</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a><span class="do">## Event Settings -----------------------------------------------------------------</span></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>Pre_stim <span class="ot">=</span> <span class="dv">100</span></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>Post_stim <span class="ot">=</span> <span class="dv">2000</span></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>Fs <span class="ot">=</span> <span class="dv">300</span></span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>Time <span class="ot">=</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="sc">-</span>Pre_stim, <span class="at">by =</span> <span class="dv">1000</span> <span class="sc">/</span> Fs, <span class="at">length.out =</span> (Pre_stim <span class="sc">+</span> Post_stim) <span class="sc">/</span> <span class="dv">1000</span> <span class="sc">*</span> <span class="dv">300</span> <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>Trial_data <span class="ot">=</span> Raw_data</span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a><span class="do">## Extend Events -----------------------------------------------------------------</span></span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (trial <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(Events)) {</span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>  Sub <span class="ot">=</span> Events[trial, <span class="st">'Subject'</span>]</span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a>  Event <span class="ot">=</span> Events[trial, <span class="st">'Events'</span>]</span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>  TrialN <span class="ot">=</span> Events[trial, <span class="st">'TrialN'</span>]</span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a>  Onset <span class="ot">=</span> Events[trial, <span class="st">'Time'</span>]</span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a>  rows_to_update <span class="ot">=</span> <span class="fu">which</span>(Trial_data<span class="sc">$</span>Subject <span class="sc">==</span> Sub <span class="sc">&amp;</span></span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a>                           Trial_data<span class="sc">$</span>Time <span class="sc">&gt;=</span> (Onset <span class="sc">-</span> Pre_stim) <span class="sc">&amp;</span></span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>                           Trial_data<span class="sc">$</span>Time <span class="sc">&lt;</span> (Onset <span class="sc">+</span> Post_stim))</span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a>  Trial_data[rows_to_update, <span class="st">'Time'</span>] <span class="ot">=</span> Time</span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a>  Trial_data[rows_to_update, <span class="st">'Events'</span>] <span class="ot">=</span> Event</span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>  Trial_data[rows_to_update, <span class="st">'TrialN'</span>] <span class="ot">=</span> TrialN</span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a><span class="do">## Filter Events -----------------------------------------------------------------</span></span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a>Trial_data <span class="ot">=</span> Trial_data <span class="sc">%&gt;%</span> </span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Events <span class="sc">%in%</span> Events_to_keep)</span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a><span class="do">### Plot Events -----------------------------------------------------------------</span></span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(Trial_data, <span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> PupilR, <span class="at">group =</span> TrialN)) <span class="sc">+</span></span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> PupilR, <span class="at">color =</span> <span class="st">'Pupil Right'</span>), <span class="at">lwd =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> PupilL, <span class="at">color =</span> <span class="st">'Pupil Left'</span>), <span class="at">lwd =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="dv">0</span>), <span class="at">linetype =</span> <span class="st">'dashed'</span>, <span class="at">color =</span> <span class="st">'black'</span>, <span class="at">lwd =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Subject) <span class="sc">+</span></span>
<span id="cb28-81"><a href="#cb28-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">1</span>, <span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb28-82"><a href="#cb28-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">'Pupil Right'</span> <span class="ot">=</span> <span class="st">'#4A6274'</span>, <span class="st">'Pupil Left'</span> <span class="ot">=</span> <span class="st">'#E2725A'</span>)) <span class="sc">+</span></span>
<span id="cb28-83"><a href="#cb28-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">35</span>) <span class="sc">+</span></span>
<span id="cb28-84"><a href="#cb28-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb28-85"><a href="#cb28-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">lwd =</span> <span class="dv">20</span>)))</span>
<span id="cb28-86"><a href="#cb28-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-87"><a href="#cb28-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-88"><a href="#cb28-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Pre-processing -----------------------------------------------------------------</span></span>
<span id="cb28-89"><a href="#cb28-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-90"><a href="#cb28-90" aria-hidden="true" tabindex="-1"></a><span class="do">## Make PupillometryR Data -----------------------------------------------------------------</span></span>
<span id="cb28-91"><a href="#cb28-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-92"><a href="#cb28-92" aria-hidden="true" tabindex="-1"></a>PupilR_data <span class="ot">=</span> <span class="fu">make_pupillometryr_data</span>(<span class="at">data =</span> Trial_data,</span>
<span id="cb28-93"><a href="#cb28-93" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">subject =</span> Subject,</span>
<span id="cb28-94"><a href="#cb28-94" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">trial =</span> TrialN,</span>
<span id="cb28-95"><a href="#cb28-95" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">time =</span> Time,</span>
<span id="cb28-96"><a href="#cb28-96" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">condition =</span> Events)</span>
<span id="cb28-97"><a href="#cb28-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-98"><a href="#cb28-98" aria-hidden="true" tabindex="-1"></a><span class="do">### Plot ------------------------------------------------------------------</span></span>
<span id="cb28-99"><a href="#cb28-99" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(PupilR_data, <span class="at">pupil =</span> PupilL, <span class="at">group =</span> <span class="st">'condition'</span>, <span class="at">geom =</span> <span class="st">'line'</span>) <span class="sc">+</span></span>
<span id="cb28-100"><a href="#cb28-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">45</span>) <span class="sc">+</span></span>
<span id="cb28-101"><a href="#cb28-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb28-102"><a href="#cb28-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">'bottom'</span>, </span>
<span id="cb28-103"><a href="#cb28-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb28-104"><a href="#cb28-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">lwd =</span> <span class="dv">20</span>))) </span>
<span id="cb28-105"><a href="#cb28-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-106"><a href="#cb28-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-107"><a href="#cb28-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-108"><a href="#cb28-108" aria-hidden="true" tabindex="-1"></a><span class="do">## Regress Data -----------------------------------------------------------------</span></span>
<span id="cb28-109"><a href="#cb28-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-110"><a href="#cb28-110" aria-hidden="true" tabindex="-1"></a>Regressed_data <span class="ot">&lt;-</span> <span class="fu">regress_data</span>(<span class="at">data =</span> PupilR_data,</span>
<span id="cb28-111"><a href="#cb28-111" aria-hidden="true" tabindex="-1"></a>                               <span class="at">pupil1 =</span> PupilL,</span>
<span id="cb28-112"><a href="#cb28-112" aria-hidden="true" tabindex="-1"></a>                               <span class="at">pupil2 =</span> PupilR)</span>
<span id="cb28-113"><a href="#cb28-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-114"><a href="#cb28-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-115"><a href="#cb28-115" aria-hidden="true" tabindex="-1"></a><span class="do">## Filter Out Trials with NA -----------------------------------------------------------------</span></span>
<span id="cb28-116"><a href="#cb28-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-117"><a href="#cb28-117" aria-hidden="true" tabindex="-1"></a>Trial_data <span class="ot">&lt;-</span> Trial_data <span class="sc">%&gt;%</span></span>
<span id="cb28-118"><a href="#cb28-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Subject, TrialN) <span class="sc">%&gt;%</span></span>
<span id="cb28-119"><a href="#cb28-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">all</span>(<span class="fu">is.na</span>(PupilL) <span class="sc">&amp;</span> <span class="fu">is.na</span>(PupilR))) <span class="sc">%&gt;%</span></span>
<span id="cb28-120"><a href="#cb28-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb28-121"><a href="#cb28-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-122"><a href="#cb28-122" aria-hidden="true" tabindex="-1"></a>PupilR_data <span class="ot">=</span> <span class="fu">make_pupillometryr_data</span>(<span class="at">data =</span> Trial_data,</span>
<span id="cb28-123"><a href="#cb28-123" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">subject =</span> Subject,</span>
<span id="cb28-124"><a href="#cb28-124" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">trial =</span> TrialN,</span>
<span id="cb28-125"><a href="#cb28-125" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">time =</span> Time,</span>
<span id="cb28-126"><a href="#cb28-126" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">condition =</span> Events)</span>
<span id="cb28-127"><a href="#cb28-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-128"><a href="#cb28-128" aria-hidden="true" tabindex="-1"></a>Regressed_data <span class="ot">&lt;-</span> <span class="fu">regress_data</span>(<span class="at">data =</span> PupilR_data,</span>
<span id="cb28-129"><a href="#cb28-129" aria-hidden="true" tabindex="-1"></a>                               <span class="at">pupil1 =</span> PupilL,</span>
<span id="cb28-130"><a href="#cb28-130" aria-hidden="true" tabindex="-1"></a>                               <span class="at">pupil2 =</span> PupilR)</span>
<span id="cb28-131"><a href="#cb28-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-132"><a href="#cb28-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-133"><a href="#cb28-133" aria-hidden="true" tabindex="-1"></a><span class="do">## Calculate Mean Pupil -----------------------------------------------------------------</span></span>
<span id="cb28-134"><a href="#cb28-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-135"><a href="#cb28-135" aria-hidden="true" tabindex="-1"></a>Mean_data <span class="ot">&lt;-</span> <span class="fu">calculate_mean_pupil_size</span>(<span class="at">data =</span> Regressed_data, </span>
<span id="cb28-136"><a href="#cb28-136" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">pupil1 =</span> PupilL, </span>
<span id="cb28-137"><a href="#cb28-137" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">pupil2 =</span> PupilR)</span>
<span id="cb28-138"><a href="#cb28-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-139"><a href="#cb28-139" aria-hidden="true" tabindex="-1"></a><span class="do">### Plot --------------------------------------------------------------------</span></span>
<span id="cb28-140"><a href="#cb28-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-141"><a href="#cb28-141" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(Mean_data, <span class="at">pupil =</span> mean_pupil, <span class="at">group =</span> <span class="st">'condition'</span>, <span class="at">geom =</span> <span class="st">'line'</span>)<span class="sc">+</span></span>
<span id="cb28-142"><a href="#cb28-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">45</span>) <span class="sc">+</span></span>
<span id="cb28-143"><a href="#cb28-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb28-144"><a href="#cb28-144" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">'bottom'</span>, </span>
<span id="cb28-145"><a href="#cb28-145" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb28-146"><a href="#cb28-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">lwd =</span> <span class="dv">20</span>))) </span>
<span id="cb28-147"><a href="#cb28-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-148"><a href="#cb28-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-149"><a href="#cb28-149" aria-hidden="true" tabindex="-1"></a><span class="do">## Lowpass Filter -----------------------------------------------------------------</span></span>
<span id="cb28-150"><a href="#cb28-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-151"><a href="#cb28-151" aria-hidden="true" tabindex="-1"></a>filtered_data <span class="ot">&lt;-</span> <span class="fu">filter_data</span>(<span class="at">data =</span> Mean_data,</span>
<span id="cb28-152"><a href="#cb28-152" aria-hidden="true" tabindex="-1"></a>                             <span class="at">pupil =</span> mean_pupil,</span>
<span id="cb28-153"><a href="#cb28-153" aria-hidden="true" tabindex="-1"></a>                             <span class="at">filter =</span> <span class="st">'median'</span>,</span>
<span id="cb28-154"><a href="#cb28-154" aria-hidden="true" tabindex="-1"></a>                             <span class="at">degree =</span> <span class="dv">11</span>)</span>
<span id="cb28-155"><a href="#cb28-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-156"><a href="#cb28-156" aria-hidden="true" tabindex="-1"></a><span class="do">### Plot --------------------------------------------------------------------</span></span>
<span id="cb28-157"><a href="#cb28-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-158"><a href="#cb28-158" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(filtered_data, <span class="at">pupil =</span> mean_pupil, <span class="at">group =</span> <span class="st">'condition'</span>, <span class="at">geom =</span> <span class="st">'line'</span>)<span class="sc">+</span></span>
<span id="cb28-159"><a href="#cb28-159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">45</span>) <span class="sc">+</span></span>
<span id="cb28-160"><a href="#cb28-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb28-161"><a href="#cb28-161" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">'bottom'</span>, </span>
<span id="cb28-162"><a href="#cb28-162" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb28-163"><a href="#cb28-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">lwd =</span> <span class="dv">20</span>))) </span>
<span id="cb28-164"><a href="#cb28-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-165"><a href="#cb28-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-166"><a href="#cb28-166" aria-hidden="true" tabindex="-1"></a><span class="do">## Downsample -----------------------------------------------------------------</span></span>
<span id="cb28-167"><a href="#cb28-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-168"><a href="#cb28-168" aria-hidden="true" tabindex="-1"></a>NewHz <span class="ot">=</span> <span class="dv">20</span></span>
<span id="cb28-169"><a href="#cb28-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-170"><a href="#cb28-170" aria-hidden="true" tabindex="-1"></a>timebinSize <span class="ot">=</span> <span class="dv">1</span> <span class="sc">/</span> NewHz</span>
<span id="cb28-171"><a href="#cb28-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-172"><a href="#cb28-172" aria-hidden="true" tabindex="-1"></a>Downsampled_data <span class="ot">&lt;-</span> <span class="fu">downsample_time_data</span>(<span class="at">data =</span> filtered_data,</span>
<span id="cb28-173"><a href="#cb28-173" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">pupil =</span> mean_pupil,</span>
<span id="cb28-174"><a href="#cb28-174" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">timebin_size =</span> timebinSize,</span>
<span id="cb28-175"><a href="#cb28-175" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">option =</span> <span class="st">'median'</span>)</span>
<span id="cb28-176"><a href="#cb28-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-177"><a href="#cb28-177" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot --------------------------------------------------------------------</span></span>
<span id="cb28-178"><a href="#cb28-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-179"><a href="#cb28-179" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(Downsampled_data, <span class="at">pupil =</span> mean_pupil, <span class="at">group =</span> <span class="st">'condition'</span>, <span class="at">geom =</span> <span class="st">'line'</span>) <span class="sc">+</span></span>
<span id="cb28-180"><a href="#cb28-180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">45</span>) <span class="sc">+</span></span>
<span id="cb28-181"><a href="#cb28-181" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb28-182"><a href="#cb28-182" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">'bottom'</span>, </span>
<span id="cb28-183"><a href="#cb28-183" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb28-184"><a href="#cb28-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">lwd =</span> <span class="dv">20</span>))) </span>
<span id="cb28-185"><a href="#cb28-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-186"><a href="#cb28-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-187"><a href="#cb28-187" aria-hidden="true" tabindex="-1"></a><span class="do">## Calculate Missing Data -----------------------------------------------------------------</span></span>
<span id="cb28-188"><a href="#cb28-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-189"><a href="#cb28-189" aria-hidden="true" tabindex="-1"></a>Missing_data <span class="ot">&lt;-</span> <span class="fu">calculate_missing_data</span>(Downsampled_data, mean_pupil)</span>
<span id="cb28-190"><a href="#cb28-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-191"><a href="#cb28-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-192"><a href="#cb28-192" aria-hidden="true" tabindex="-1"></a><span class="do">## Clean Missing Data -----------------------------------------------------------------</span></span>
<span id="cb28-193"><a href="#cb28-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-194"><a href="#cb28-194" aria-hidden="true" tabindex="-1"></a>Clean_data <span class="ot">&lt;-</span> <span class="fu">clean_missing_data</span>(Downsampled_data,</span>
<span id="cb28-195"><a href="#cb28-195" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">pupil =</span> mean_pupil,</span>
<span id="cb28-196"><a href="#cb28-196" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">trial_threshold =</span> .<span class="dv">75</span>,</span>
<span id="cb28-197"><a href="#cb28-197" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">subject_trial_threshold =</span> .<span class="dv">75</span>)</span>
<span id="cb28-198"><a href="#cb28-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-199"><a href="#cb28-199" aria-hidden="true" tabindex="-1"></a><span class="do">### Plot --------------------------------------------------------------------</span></span>
<span id="cb28-200"><a href="#cb28-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-201"><a href="#cb28-201" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(Clean_data, <span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> mean_pupil, <span class="at">group =</span> TrialN, <span class="at">color=</span> Events))<span class="sc">+</span></span>
<span id="cb28-202"><a href="#cb28-202" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>( <span class="at">lwd =</span><span class="fl">1.2</span>)<span class="sc">+</span></span>
<span id="cb28-203"><a href="#cb28-203" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="dv">0</span>), <span class="at">linetype=</span> <span class="st">'dashed'</span>, <span class="at">color =</span> <span class="st">'black'</span>, <span class="at">lwd =</span><span class="fl">1.2</span>)<span class="sc">+</span></span>
<span id="cb28-204"><a href="#cb28-204" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-205"><a href="#cb28-205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Subject)<span class="sc">+</span></span>
<span id="cb28-206"><a href="#cb28-206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">1</span>,<span class="dv">6</span>)<span class="sc">+</span></span>
<span id="cb28-207"><a href="#cb28-207" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-208"><a href="#cb28-208" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">45</span>) <span class="sc">+</span></span>
<span id="cb28-209"><a href="#cb28-209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb28-210"><a href="#cb28-210" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">'bottom'</span>, </span>
<span id="cb28-211"><a href="#cb28-211" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb28-212"><a href="#cb28-212" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">lwd =</span> <span class="dv">20</span>))) </span>
<span id="cb28-213"><a href="#cb28-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-214"><a href="#cb28-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-215"><a href="#cb28-215" aria-hidden="true" tabindex="-1"></a><span class="do">## Detect Blinks -----------------------------------------------------------------</span></span>
<span id="cb28-216"><a href="#cb28-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-217"><a href="#cb28-217" aria-hidden="true" tabindex="-1"></a>Blink_data <span class="ot">=</span> <span class="fu">detect_blinks_by_velocity</span>(</span>
<span id="cb28-218"><a href="#cb28-218" aria-hidden="true" tabindex="-1"></a>  Clean_data,</span>
<span id="cb28-219"><a href="#cb28-219" aria-hidden="true" tabindex="-1"></a>  mean_pupil,</span>
<span id="cb28-220"><a href="#cb28-220" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold =</span> <span class="fl">0.1</span>,</span>
<span id="cb28-221"><a href="#cb28-221" aria-hidden="true" tabindex="-1"></a>  <span class="at">extend_forward =</span> <span class="dv">50</span>,</span>
<span id="cb28-222"><a href="#cb28-222" aria-hidden="true" tabindex="-1"></a>  <span class="at">extend_back =</span> <span class="dv">50</span>)</span>
<span id="cb28-223"><a href="#cb28-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-224"><a href="#cb28-224" aria-hidden="true" tabindex="-1"></a><span class="do">### Plot --------------------------------------------------------------------</span></span>
<span id="cb28-225"><a href="#cb28-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-226"><a href="#cb28-226" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(Blink_data, <span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> mean_pupil, <span class="at">group =</span> TrialN, <span class="at">color=</span>Events))<span class="sc">+</span></span>
<span id="cb28-227"><a href="#cb28-227" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">lwd =</span><span class="fl">1.2</span>)<span class="sc">+</span></span>
<span id="cb28-228"><a href="#cb28-228" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="dv">0</span>), <span class="at">linetype=</span> <span class="st">'dashed'</span>, <span class="at">color =</span> <span class="st">'black'</span>, <span class="at">lwd =</span><span class="fl">1.2</span>)<span class="sc">+</span></span>
<span id="cb28-229"><a href="#cb28-229" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-230"><a href="#cb28-230" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Subject)<span class="sc">+</span></span>
<span id="cb28-231"><a href="#cb28-231" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">1</span>,<span class="dv">6</span>)<span class="sc">+</span></span>
<span id="cb28-232"><a href="#cb28-232" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-233"><a href="#cb28-233" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">45</span>) <span class="sc">+</span></span>
<span id="cb28-234"><a href="#cb28-234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb28-235"><a href="#cb28-235" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">'bottom'</span>, </span>
<span id="cb28-236"><a href="#cb28-236" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb28-237"><a href="#cb28-237" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">lwd =</span> <span class="dv">20</span>))) </span>
<span id="cb28-238"><a href="#cb28-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-239"><a href="#cb28-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-240"><a href="#cb28-240" aria-hidden="true" tabindex="-1"></a><span class="do">## Interpolate Data -----------------------------------------------------------------</span></span>
<span id="cb28-241"><a href="#cb28-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-242"><a href="#cb28-242" aria-hidden="true" tabindex="-1"></a>Int_data <span class="ot">&lt;-</span> <span class="fu">interpolate_data</span>(<span class="at">data =</span> Blink_data,</span>
<span id="cb28-243"><a href="#cb28-243" aria-hidden="true" tabindex="-1"></a>                             <span class="at">pupil =</span> mean_pupil,</span>
<span id="cb28-244"><a href="#cb28-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-245"><a href="#cb28-245" aria-hidden="true" tabindex="-1"></a><span class="do">### Plot --------------------------------------------------------------------</span></span>
<span id="cb28-246"><a href="#cb28-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-247"><a href="#cb28-247" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(Int_data, <span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> mean_pupil, <span class="at">group =</span> TrialN, <span class="at">color =</span> Events))<span class="sc">+</span></span>
<span id="cb28-248"><a href="#cb28-248" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">lwd =</span><span class="fl">1.2</span>)<span class="sc">+</span></span>
<span id="cb28-249"><a href="#cb28-249" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="dv">0</span>), <span class="at">linetype=</span> <span class="st">'dashed'</span>, <span class="at">color =</span> <span class="st">'black'</span>, <span class="at">lwd =</span><span class="fl">1.2</span>)<span class="sc">+</span></span>
<span id="cb28-250"><a href="#cb28-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-251"><a href="#cb28-251" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Subject)<span class="sc">+</span></span>
<span id="cb28-252"><a href="#cb28-252" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">1</span>,<span class="dv">6</span>)<span class="sc">+</span></span>
<span id="cb28-253"><a href="#cb28-253" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-254"><a href="#cb28-254" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">45</span>) <span class="sc">+</span></span>
<span id="cb28-255"><a href="#cb28-255" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb28-256"><a href="#cb28-256" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">'bottom'</span>, </span>
<span id="cb28-257"><a href="#cb28-257" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb28-258"><a href="#cb28-258" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">lwd =</span> <span class="dv">20</span>)))</span>
<span id="cb28-259"><a href="#cb28-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-260"><a href="#cb28-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-261"><a href="#cb28-261" aria-hidden="true" tabindex="-1"></a><span class="co"># Baseline correction -----------------------------------------------------</span></span>
<span id="cb28-262"><a href="#cb28-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-263"><a href="#cb28-263" aria-hidden="true" tabindex="-1"></a>base_data <span class="ot">&lt;-</span> <span class="fu">baseline_data</span>(<span class="at">data =</span> Int_data,</span>
<span id="cb28-264"><a href="#cb28-264" aria-hidden="true" tabindex="-1"></a>                           <span class="at">pupil =</span> mean_pupil,</span>
<span id="cb28-265"><a href="#cb28-265" aria-hidden="true" tabindex="-1"></a>                           <span class="at">start =</span> <span class="sc">-</span><span class="dv">100</span>,</span>
<span id="cb28-266"><a href="#cb28-266" aria-hidden="true" tabindex="-1"></a>                           <span class="at">stop =</span> <span class="dv">0</span>)</span>
<span id="cb28-267"><a href="#cb28-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-268"><a href="#cb28-268" aria-hidden="true" tabindex="-1"></a><span class="do">### Final plot --------------------------------------------------------------</span></span>
<span id="cb28-269"><a href="#cb28-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-270"><a href="#cb28-270" aria-hidden="true" tabindex="-1"></a><span class="at">One =</span> <span class="fu">plot</span>(base_data, <span class="at">pupil =</span> mean_pupil, <span class="at">group =</span> <span class="st">'condition'</span>)<span class="sc">+</span></span>
<span id="cb28-271"><a href="#cb28-271" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">45</span>) <span class="sc">+</span></span>
<span id="cb28-272"><a href="#cb28-272" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'none'</span>)</span>
<span id="cb28-273"><a href="#cb28-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-274"><a href="#cb28-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-275"><a href="#cb28-275" aria-hidden="true" tabindex="-1"></a><span class="at">Two =</span> <span class="fu">ggplot</span>(base_data, <span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> mean_pupil, <span class="at">group =</span> TrialN, <span class="at">color =</span> Events))<span class="sc">+</span></span>
<span id="cb28-276"><a href="#cb28-276" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">lwd =</span><span class="fl">1.2</span>)<span class="sc">+</span></span>
<span id="cb28-277"><a href="#cb28-277" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="dv">0</span>), <span class="at">linetype=</span> <span class="st">'dashed'</span>, <span class="at">color =</span> <span class="st">'black'</span>, <span class="at">lwd =</span><span class="fl">1.2</span>)<span class="sc">+</span></span>
<span id="cb28-278"><a href="#cb28-278" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-279"><a href="#cb28-279" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Subject)<span class="sc">+</span></span>
<span id="cb28-280"><a href="#cb28-280" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-281"><a href="#cb28-281" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">45</span>) <span class="sc">+</span></span>
<span id="cb28-282"><a href="#cb28-282" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb28-283"><a href="#cb28-283" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">'bottom'</span>, </span>
<span id="cb28-284"><a href="#cb28-284" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb28-285"><a href="#cb28-285" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">lwd =</span> <span class="dv">20</span>))) </span>
<span id="cb28-286"><a href="#cb28-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-287"><a href="#cb28-287" aria-hidden="true" tabindex="-1"></a>One <span class="sc">/</span> Two</span>
<span id="cb28-288"><a href="#cb28-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-289"><a href="#cb28-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-290"><a href="#cb28-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-291"><a href="#cb28-291" aria-hidden="true" tabindex="-1"></a><span class="co"># Save data ---------------------------------------------------------------</span></span>
<span id="cb28-292"><a href="#cb28-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-293"><a href="#cb28-293" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(<span class="st">'"..</span><span class="sc">\\</span><span class="st">..</span><span class="sc">\\</span><span class="st">resources</span><span class="sc">\\</span><span class="st">Pupillometry</span><span class="sc">\\</span><span class="st">ProcessedPupilData.csv"'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


<!-- -->

</section><a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/tommasoghilardi\.github\.io\/DevStart\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../../CONTENT/EyeTracking/FromFixationsToData.html" class="pagination-link" aria-label="From fixations to measures">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">From fixations to measures</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb29" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Pre-processing Pupillometry"</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co">  </span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="an">author-meta:</span><span class="co"> "Tommaso Ghilardi"</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="an">description-meta:</span><span class="co"> "Learn the fundamentals of pupil dilation processing using PupillometryR"</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="an">keywords:</span><span class="co"> "pupil dilation, pupillometry, eye-tracking, experiments, infant research, DevStart, developmental science"</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="co">  - Pupillometry</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co">  - R</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="co">  - Pre-processing</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="an">lightbox:</span><span class="co"> true</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="an">draft:</span><span class="co"> true</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="an">draft-mode:</span><span class="co"> unlinked</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>Welcome to your first step into the world of pupillometry! In this tutorial, we‚Äôll walk you through how to preprocess pupil data using a handy R package called <span class="co">[</span><span class="ot">PupillometryR</span><span class="co">](http://samforbes.me/PupillometryR/index.html)</span>. This package makes it simple to clean and even analyze your pupil data with just a few lines of R code.</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>To keep things straightforward, we‚Äôll be working with a simulated dataset that you can download right here (insert link). This dataset is based on the experimental design we introduced earlier in our eye-tracking series. If you‚Äôre not familiar with it or need a quick refresher, we recommend checking out the "<span class="co">[</span><span class="ot">Introduction to eye-tracking</span><span class="co">](Intro_eyetracking.qmd)</span>" guide before diving in.</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>This tutorial serves as a foundation for understanding how to preprocess pupil data. Once you've grasped the essentials, we encourage you to explore the full range of functions and features <span class="co">[</span><span class="ot">PupillometryR</span><span class="co">](http://samforbes.me/PupillometryR)</span> has to offer.</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a><span class="fu">## Read the data</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>Let's begin by importing the necessary libraries and loading the downloaded dataframe.</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a><span class="in">```{r SettingAndLibraries}</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a><span class="in">#| echo: false</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a><span class="in">#| message: false</span></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a><span class="in">setwd("C:\\Users\\tomma\\OneDrive - Birkbeck, University of London\\Personal\\Web\\DevStart\\resources\\Pupillometry")</span></span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a><span class="in">library(PupillometryR)  # Library to process pupil signal</span></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)  # Library to wrangle dataframes</span></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a><span class="in">library(patchwork)</span></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>Perfect now let's read our dataframe</span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a><span class="in">```{r ReadData}</span></span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a><span class="in">Raw_data = read.csv("..\\..\\resources\\Pupillometry\\PupilData.csv")</span></span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a><span class="in">head(Raw_data) # database peak</span></span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>Our dataframe consists of several easily interpretable columns. **Time** represents elapsed time in milliseconds, **Subject** identifies the participant, and **Events** indicates when and which stimuli were presented. **TrialN** tracks the trial number, while **PupilL** and **PupilR** measure pupil dilation for the left and right eyes, respectively, in millimeters.</span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a>Let's plot the data! Visualizing it first is always a crucial step as it provides an initial understanding of its structure and key patterns.</span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a><span class="in">```{r PlotRaw}</span></span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a><span class="in">#| warnings: false</span></span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-width: 20</span></span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-height: 10</span></span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(Raw_data, aes(x = Time, y = PupilR))+</span></span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(aes(y = PupilR, color = 'Pupil Right'), lwd = 1.2) +</span></span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(aes(y = PupilL, color = 'Pupil Left'), lwd = 1.2) +</span></span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(data = Raw_data |&gt; dplyr::filter(!is.na(Events)) , aes(xintercept = Time, color = Events), linetype = 'dashed') +</span></span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(~Subject)+</span></span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw(base_size = 35)+</span></span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a><span class="in">  ylim(1,6)+</span></span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(values = c('Pupil Right' = '#4A6274', 'Pupil Left' = '#E2725A'))+</span></span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = 'bottom') +</span></span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = guide_legend(override.aes = list(lwd = 20)))  # Make legend lines thicker</span></span>
<span id="cb29-64"><a href="#cb29-64" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-65"><a href="#cb29-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-66"><a href="#cb29-66" aria-hidden="true" tabindex="-1"></a><span class="fu">## Prepare the data</span></span>
<span id="cb29-67"><a href="#cb29-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-68"><a href="#cb29-68" aria-hidden="true" tabindex="-1"></a>Now that we've visualized the data, you‚Äôve probably noticed two things:</span>
<span id="cb29-69"><a href="#cb29-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-70"><a href="#cb29-70" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**So many events!** That‚Äôs intentional ‚Äî it‚Äôs better to have too many triggers than miss something important. But don‚Äôt worry, for our pupil dilation analysis, we only care about two key events: **Circle** and **Square** (check the paradigm intro if you need a refresher on why that is).</span>
<span id="cb29-71"><a href="#cb29-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-72"><a href="#cb29-72" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Single-sample events!** Like in most studies, events are marked at a single time point (when the stimulus is presented). But PupilometryR needs a different structure ‚Äî it expects the event value to be repeated for every row while the event is happening.</span>
<span id="cb29-73"><a href="#cb29-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-74"><a href="#cb29-74" aria-hidden="true" tabindex="-1"></a>So, how do we fix this? First, let‚Äôs isolate the rows in our dataframe where the events are **Circle** or **Square**. We start by creating a list of the events we care about, then use it to filter our dataframe and keep only the rows related to those events in a new dataframe called Events</span>
<span id="cb29-75"><a href="#cb29-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-76"><a href="#cb29-76" aria-hidden="true" tabindex="-1"></a><span class="in">```{r FindEvents}</span></span>
<span id="cb29-77"><a href="#cb29-77" aria-hidden="true" tabindex="-1"></a><span class="in">Events_to_keep = c('Circle','Square')</span></span>
<span id="cb29-78"><a href="#cb29-78" aria-hidden="true" tabindex="-1"></a><span class="in">Events = filter(Raw_data, Events %in% Events_to_keep) # filter data</span></span>
<span id="cb29-79"><a href="#cb29-79" aria-hidden="true" tabindex="-1"></a><span class="in">head(Events) # database peak</span></span>
<span id="cb29-80"><a href="#cb29-80" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-81"><a href="#cb29-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-82"><a href="#cb29-82" aria-hidden="true" tabindex="-1"></a>Perfect! Now onto the second point: we need to repeat the events we just selected for the entire duration we want to analyze. But what‚Äôs this duration? We want to cover the full cue presentation (2 seconds), plus an extra 0.5 seconds before the stimulus appears. Why? This pre-stimulus period will serve as our baseline, which we‚Äôll use later in the analysis.</span>
<span id="cb29-83"><a href="#cb29-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-84"><a href="#cb29-84" aria-hidden="true" tabindex="-1"></a>So, let‚Äôs define how much time to include before and after the stimulus. We‚Äôll also set the framerate of our data (**300Hz**) and create a time vector that starts from the pre-stimulus period and continues in steps of 1/Hz, with a total length equal to Pre_stim + Post_stim. In addition we also create a copy of our raw data called Trial_data. We do this so the original data stays intact, and all our edits happen on the copy</span>
<span id="cb29-85"><a href="#cb29-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-86"><a href="#cb29-86" aria-hidden="true" tabindex="-1"></a><span class="in">```{r EventsSettings}</span></span>
<span id="cb29-87"><a href="#cb29-87" aria-hidden="true" tabindex="-1"></a><span class="in"># Settings to cut events</span></span>
<span id="cb29-88"><a href="#cb29-88" aria-hidden="true" tabindex="-1"></a><span class="in">Pre_stim = 100 # pre stimulus time</span></span>
<span id="cb29-89"><a href="#cb29-89" aria-hidden="true" tabindex="-1"></a><span class="in">Post_stim = 2000 # post stimulus time</span></span>
<span id="cb29-90"><a href="#cb29-90" aria-hidden="true" tabindex="-1"></a><span class="in">Fs = 300 # framerate</span></span>
<span id="cb29-91"><a href="#cb29-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-92"><a href="#cb29-92" aria-hidden="true" tabindex="-1"></a><span class="in">Time = seq(from = -Pre_stim, by=1000/Fs, length.out = (Pre_stim+Post_stim)/1000*300-1) # time vector</span></span>
<span id="cb29-93"><a href="#cb29-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-94"><a href="#cb29-94" aria-hidden="true" tabindex="-1"></a><span class="in"># create copy of the raw data</span></span>
<span id="cb29-95"><a href="#cb29-95" aria-hidden="true" tabindex="-1"></a><span class="in">Trial_data = Raw_data </span></span>
<span id="cb29-96"><a href="#cb29-96" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-97"><a href="#cb29-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-98"><a href="#cb29-98" aria-hidden="true" tabindex="-1"></a>Here‚Äôs where the magic happens. We loop through each event listed in our **Events** dataframe. Each row in Events corresponds to a specific event (like a "Circle" or "Square" cue) that occurred for a specific subject during a specific trial.</span>
<span id="cb29-99"><a href="#cb29-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-100"><a href="#cb29-100" aria-hidden="true" tabindex="-1"></a>For each event, we extract three key details:</span>
<span id="cb29-101"><a href="#cb29-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-102"><a href="#cb29-102" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Subject** (to know which participant the event is for)</span>
<span id="cb29-103"><a href="#cb29-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-104"><a href="#cb29-104" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Event** (to know if it's a Circle or Square cue)</span>
<span id="cb29-105"><a href="#cb29-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-106"><a href="#cb29-106" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**TrialN** (to know which trial this event is part of)</span>
<span id="cb29-107"><a href="#cb29-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-108"><a href="#cb29-108" aria-hidden="true" tabindex="-1"></a>Next, we identify the rows of interest in our dataframe. We look for rows where the Subject matches the current participant, and the Time falls within the window from Pre_stim to Post_stim relative to the event's start.</span>
<span id="cb29-109"><a href="#cb29-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-110"><a href="#cb29-110" aria-hidden="true" tabindex="-1"></a>Finally, we use these identified rows to add the event information. The Time, Event, and TrialN values are repeated across all the rows in this window, ensuring every row in the event window is properly labeled.</span>
<span id="cb29-111"><a href="#cb29-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-112"><a href="#cb29-112" aria-hidden="true" tabindex="-1"></a><span class="in">```{r ExtendEvents}</span></span>
<span id="cb29-113"><a href="#cb29-113" aria-hidden="true" tabindex="-1"></a><span class="in"># Loop for each event of each subject</span></span>
<span id="cb29-114"><a href="#cb29-114" aria-hidden="true" tabindex="-1"></a><span class="in">for (trial in 1:nrow(Events)){</span></span>
<span id="cb29-115"><a href="#cb29-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-116"><a href="#cb29-116" aria-hidden="true" tabindex="-1"></a><span class="in">    # Extract the information</span></span>
<span id="cb29-117"><a href="#cb29-117" aria-hidden="true" tabindex="-1"></a><span class="in">    Sub = Events[trial, 'Subject']</span></span>
<span id="cb29-118"><a href="#cb29-118" aria-hidden="true" tabindex="-1"></a><span class="in">    Event = Events[trial, 'Events']</span></span>
<span id="cb29-119"><a href="#cb29-119" aria-hidden="true" tabindex="-1"></a><span class="in">    TrialN = Events[trial, 'TrialN']</span></span>
<span id="cb29-120"><a href="#cb29-120" aria-hidden="true" tabindex="-1"></a><span class="in">    Onset = Events[trial, 'Time']</span></span>
<span id="cb29-121"><a href="#cb29-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-122"><a href="#cb29-122" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb29-123"><a href="#cb29-123" aria-hidden="true" tabindex="-1"></a><span class="in">    # Find the rows to update based on subject and time</span></span>
<span id="cb29-124"><a href="#cb29-124" aria-hidden="true" tabindex="-1"></a><span class="in">    rows_to_update = which(Trial_data$Subject == Sub &amp;</span></span>
<span id="cb29-125"><a href="#cb29-125" aria-hidden="true" tabindex="-1"></a><span class="in">                           Trial_data$Time &gt;= (Onset - Pre_stim) &amp;</span></span>
<span id="cb29-126"><a href="#cb29-126" aria-hidden="true" tabindex="-1"></a><span class="in">                           Trial_data$Time &lt; (Onset + Post_stim))</span></span>
<span id="cb29-127"><a href="#cb29-127" aria-hidden="true" tabindex="-1"></a><span class="in">   </span></span>
<span id="cb29-128"><a href="#cb29-128" aria-hidden="true" tabindex="-1"></a><span class="in">    # Repeat the values of interest for all the rows</span></span>
<span id="cb29-129"><a href="#cb29-129" aria-hidden="true" tabindex="-1"></a><span class="in">    Trial_data[rows_to_update, 'Time'] = Time</span></span>
<span id="cb29-130"><a href="#cb29-130" aria-hidden="true" tabindex="-1"></a><span class="in">    Trial_data[rows_to_update, 'Events'] = Event</span></span>
<span id="cb29-131"><a href="#cb29-131" aria-hidden="true" tabindex="-1"></a><span class="in">    Trial_data[rows_to_update, 'TrialN'] = TrialN</span></span>
<span id="cb29-132"><a href="#cb29-132" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb29-133"><a href="#cb29-133" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-134"><a href="#cb29-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-135"><a href="#cb29-135" aria-hidden="true" tabindex="-1"></a>Perfect! We‚Äôve successfully extended the event information backward and forward based on our Pre_stim and Post_stim windows. Now, it‚Äôs time to clean things up.</span>
<span id="cb29-136"><a href="#cb29-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-137"><a href="#cb29-137" aria-hidden="true" tabindex="-1"></a>Since we only care about the rows that are part of our trial of interest, we‚Äôll remove all the rows that don‚Äôt belong to these event windows. This will leave us with a clean, focused dataset that only contains the data relevant to our analysis.</span>
<span id="cb29-138"><a href="#cb29-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-139"><a href="#cb29-139" aria-hidden="true" tabindex="-1"></a><span class="in">```{r FilterEvents}</span></span>
<span id="cb29-140"><a href="#cb29-140" aria-hidden="true" tabindex="-1"></a><span class="in">#| message: false</span></span>
<span id="cb29-141"><a href="#cb29-141" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb29-142"><a href="#cb29-142" aria-hidden="true" tabindex="-1"></a><span class="in">Trial_data = Trial_data %&gt;% </span></span>
<span id="cb29-143"><a href="#cb29-143" aria-hidden="true" tabindex="-1"></a><span class="in">    filter(Events %in% Events_to_keep)</span></span>
<span id="cb29-144"><a href="#cb29-144" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-145"><a href="#cb29-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-146"><a href="#cb29-146" aria-hidden="true" tabindex="-1"></a>Very good job reaching to this point!! if you believe it or not this was the hardest part!! We have now our different dataset!! let's take a look:</span>
<span id="cb29-147"><a href="#cb29-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-148"><a href="#cb29-148" aria-hidden="true" tabindex="-1"></a><span class="in">```{r PlotEvents}</span></span>
<span id="cb29-149"><a href="#cb29-149" aria-hidden="true" tabindex="-1"></a><span class="in">#| message: false</span></span>
<span id="cb29-150"><a href="#cb29-150" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb29-151"><a href="#cb29-151" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb29-152"><a href="#cb29-152" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-width: 40</span></span>
<span id="cb29-153"><a href="#cb29-153" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-height: 25</span></span>
<span id="cb29-154"><a href="#cb29-154" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-dpi: 300</span></span>
<span id="cb29-155"><a href="#cb29-155" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(Trial_data, aes(x = Time, y = PupilR, group = TrialN)) +</span></span>
<span id="cb29-156"><a href="#cb29-156" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(aes(y = PupilR, color = 'Pupil Right'), lwd = 1.2) +</span></span>
<span id="cb29-157"><a href="#cb29-157" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(aes(y = PupilL, color = 'Pupil Left'), lwd = 1.2) +</span></span>
<span id="cb29-158"><a href="#cb29-158" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(aes(xintercept = 0), linetype = 'dashed', color = 'black', lwd = 1.2) +</span></span>
<span id="cb29-159"><a href="#cb29-159" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(~Subject) +</span></span>
<span id="cb29-160"><a href="#cb29-160" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb29-161"><a href="#cb29-161" aria-hidden="true" tabindex="-1"></a><span class="in">  ylim(1, 6) +</span></span>
<span id="cb29-162"><a href="#cb29-162" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(values = c('Pupil Right' = '#4A6274', 'Pupil Left' = '#E2725A')) +</span></span>
<span id="cb29-163"><a href="#cb29-163" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb29-164"><a href="#cb29-164" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw(base_size = 35) +</span></span>
<span id="cb29-165"><a href="#cb29-165" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb29-166"><a href="#cb29-166" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = 'bottom', </span></span>
<span id="cb29-167"><a href="#cb29-167" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.title = element_blank()) +</span></span>
<span id="cb29-168"><a href="#cb29-168" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = guide_legend(override.aes = list(lwd = 20))) </span></span>
<span id="cb29-169"><a href="#cb29-169" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-170"><a href="#cb29-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-171"><a href="#cb29-171" aria-hidden="true" tabindex="-1"></a><span class="fu">### Make pupillometryR data</span></span>
<span id="cb29-172"><a href="#cb29-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-173"><a href="#cb29-173" aria-hidden="true" tabindex="-1"></a>Ok, now it‚Äôs time to start working with **PupillometryR**! üéâ</span>
<span id="cb29-174"><a href="#cb29-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-175"><a href="#cb29-175" aria-hidden="true" tabindex="-1"></a>In the previous steps, we changed our event structure, and you might be wondering ‚Äî why all that effort? Well, it‚Äôs because PupillometryR needs the data in this specific format to do its magic. To get started, we‚Äôll pass our dataframe to the <span class="in">`make_pupillometryr_data()`</span> function. If you‚Äôre already thinking, ‚ÄúOh no, not another weird object type that‚Äôs hard to work with!‚Äù ‚Äî don't worry! The good news is that the main object it creates is just a regular dataframe. That means we can still interact with like we‚Äôre used to. This makes the pre-processing steps much less frustrating. Let‚Äôs get started!</span>
<span id="cb29-176"><a href="#cb29-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-177"><a href="#cb29-177" aria-hidden="true" tabindex="-1"></a><span class="in">```{r MakePupillometry}</span></span>
<span id="cb29-178"><a href="#cb29-178" aria-hidden="true" tabindex="-1"></a><span class="in">#| message: false</span></span>
<span id="cb29-179"><a href="#cb29-179" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb29-180"><a href="#cb29-180" aria-hidden="true" tabindex="-1"></a><span class="in"># Trial_data[Trial_data$Subject == 'Subject_1' &amp; Trial_data$TrialN==1,]$PupilL = NA</span></span>
<span id="cb29-181"><a href="#cb29-181" aria-hidden="true" tabindex="-1"></a><span class="in"># Trial_data[Trial_data$Subject == 'Subject_1' &amp; Trial_data$TrialN==1,]$PupilR = NA</span></span>
<span id="cb29-182"><a href="#cb29-182" aria-hidden="true" tabindex="-1"></a><span class="in"># Trial_data[Trial_data$Subject == 'Subject_4' &amp; Trial_data$TrialN==1,]$PupilL = NA</span></span>
<span id="cb29-183"><a href="#cb29-183" aria-hidden="true" tabindex="-1"></a><span class="in"># Trial_data[Trial_data$Subject == 'Subject_4' &amp; Trial_data$TrialN==1,]$PupilR = NA</span></span>
<span id="cb29-184"><a href="#cb29-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-185"><a href="#cb29-185" aria-hidden="true" tabindex="-1"></a><span class="in">PupilR_data = make_pupillometryr_data(data = Trial_data,</span></span>
<span id="cb29-186"><a href="#cb29-186" aria-hidden="true" tabindex="-1"></a><span class="in">                                 subject = Subject,</span></span>
<span id="cb29-187"><a href="#cb29-187" aria-hidden="true" tabindex="-1"></a><span class="in">                                 trial = TrialN,</span></span>
<span id="cb29-188"><a href="#cb29-188" aria-hidden="true" tabindex="-1"></a><span class="in">                                 time = Time,</span></span>
<span id="cb29-189"><a href="#cb29-189" aria-hidden="true" tabindex="-1"></a><span class="in">                                 condition = Events)</span></span>
<span id="cb29-190"><a href="#cb29-190" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-191"><a href="#cb29-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-192"><a href="#cb29-192" aria-hidden="true" tabindex="-1"></a>Here, we‚Äôre simply using the **`make_pupillometryr_data()`** function to pass in our data and specify which columns contain the key information. This tells PupillometryR where to find the crucial details, like subject IDs, events, and pupil measurements, so it knows how to structure and process the data properly.</span>
<span id="cb29-193"><a href="#cb29-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-194"><a href="#cb29-194" aria-hidden="true" tabindex="-1"></a>::: callout-tip</span>
<span id="cb29-195"><a href="#cb29-195" aria-hidden="true" tabindex="-1"></a>If you have extra columns that you want to keep in your **PupillometryR** data during preprocessing, you can pass them as a list using the **`other = c(OtherColumn1, OtherColumn2)`** argument. This allows you to keep these additional columns alongside your main data throughout most of the preprocessing steps.</span>
<span id="cb29-196"><a href="#cb29-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-197"><a href="#cb29-197" aria-hidden="true" tabindex="-1"></a>But here‚Äôs a heads-up ‚Äî not all functions can keep these extra columns every time. For example, downsampling may not retain them since it reduces the number of rows, and it‚Äôs not always clear how to summarize extra columns. So, keep that in mind as you plan your analysis!</span>
<span id="cb29-198"><a href="#cb29-198" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb29-199"><a href="#cb29-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-200"><a href="#cb29-200" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Plot</span></span>
<span id="cb29-201"><a href="#cb29-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-202"><a href="#cb29-202" aria-hidden="true" tabindex="-1"></a>One cool feature of the data created using **`make_pupillometryr_data()`** is that it comes with a simple, built-in `plot` function. This makes it super easy to visualize your data without needing to write tons of code. The plot function works by averaging the data over the `group` variable. So we can group over subject or condition. Here we use the `group` variable to focus on the **condition** and average over the subjec.</span>
<span id="cb29-203"><a href="#cb29-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-204"><a href="#cb29-204" aria-hidden="true" tabindex="-1"></a>In this example, we‚Äôre plotting the PupilL (left pupil) data, grouped by condition. The <span class="in">`plot()`</span> function is actually just a ggplot2 wrapper, which means you can customize to a certain extent like any other ggplot. That‚Äôs why we can add elements to it, like **`theme_bw()`**, which gives the plot a cleaner, black-and-white look. Give it a go without adding anything and then learn to customize it!!</span>
<span id="cb29-205"><a href="#cb29-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-206"><a href="#cb29-206" aria-hidden="true" tabindex="-1"></a>::: callout-tip</span>
<span id="cb29-207"><a href="#cb29-207" aria-hidden="true" tabindex="-1"></a>**Pro tip!** If you want more control over your plots, you can always use ggplot2. Remember, the Pupil data is just a regular dataframe, so you can plot it in any way you like!</span>
<span id="cb29-208"><a href="#cb29-208" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb29-209"><a href="#cb29-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-210"><a href="#cb29-210" aria-hidden="true" tabindex="-1"></a><span class="in">```{r Pupilplot}</span></span>
<span id="cb29-211"><a href="#cb29-211" aria-hidden="true" tabindex="-1"></a><span class="in">#| message: false</span></span>
<span id="cb29-212"><a href="#cb29-212" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb29-213"><a href="#cb29-213" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-height: 25</span></span>
<span id="cb29-214"><a href="#cb29-214" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-width: 40</span></span>
<span id="cb29-215"><a href="#cb29-215" aria-hidden="true" tabindex="-1"></a><span class="in">plot(PupilR_data, pupil = PupilL, group = 'condition', geom = 'line') +</span></span>
<span id="cb29-216"><a href="#cb29-216" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw(base_size = 45) +</span></span>
<span id="cb29-217"><a href="#cb29-217" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb29-218"><a href="#cb29-218" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = 'bottom', </span></span>
<span id="cb29-219"><a href="#cb29-219" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.title = element_blank()) +</span></span>
<span id="cb29-220"><a href="#cb29-220" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = guide_legend(override.aes = list(lwd = 20))) </span></span>
<span id="cb29-221"><a href="#cb29-221" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-222"><a href="#cb29-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-223"><a href="#cb29-223" aria-hidden="true" tabindex="-1"></a>::: callout-important</span>
<span id="cb29-224"><a href="#cb29-224" aria-hidden="true" tabindex="-1"></a>In this tutorial, we‚Äôll use two methods to plot our data. We‚Äôll use the PupillometryR plot to visualize the average pupil response by condition, and we‚Äôll also use ggplot to manually plot our data. Both approaches are valid and offer unique benefits.</span>
<span id="cb29-225"><a href="#cb29-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-226"><a href="#cb29-226" aria-hidden="true" tabindex="-1"></a>The PupillometryR plot provides a quick overview by automatically averaging pupil responses across condition levels, making it ideal for high-level trend visualization. On the other hand, ggplot gives you full control to visualize specific details or customize every aspect of the plot, allowing for deeper insights and flexibility.</span>
<span id="cb29-227"><a href="#cb29-227" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb29-228"><a href="#cb29-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-229"><a href="#cb29-229" aria-hidden="true" tabindex="-1"></a><span class="fu">## Pre-processing</span></span>
<span id="cb29-230"><a href="#cb29-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-231"><a href="#cb29-231" aria-hidden="true" tabindex="-1"></a>Now that we have our pupillometry data in the required format we can actually start the pre-processing!!</span>
<span id="cb29-232"><a href="#cb29-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-233"><a href="#cb29-233" aria-hidden="true" tabindex="-1"></a><span class="fu">### Regress</span></span>
<span id="cb29-234"><a href="#cb29-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-235"><a href="#cb29-235" aria-hidden="true" tabindex="-1"></a>The first step is to regress **PupilL** against **PupilR** (and vice versa) using a simple linear regression. This corrects small inconsistencies in pupil data caused by noise. The regression is done separately for each participant, trial, and time point, ensuring smoother and more consistent pupil dilation measurements.</span>
<span id="cb29-236"><a href="#cb29-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-237"><a href="#cb29-237" aria-hidden="true" tabindex="-1"></a><span class="in">```{r Regression}</span></span>
<span id="cb29-238"><a href="#cb29-238" aria-hidden="true" tabindex="-1"></a><span class="in">#| error: true</span></span>
<span id="cb29-239"><a href="#cb29-239" aria-hidden="true" tabindex="-1"></a><span class="in">#| message: false</span></span>
<span id="cb29-240"><a href="#cb29-240" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb29-241"><a href="#cb29-241" aria-hidden="true" tabindex="-1"></a><span class="in">Regressed_data &lt;- regress_data(data = PupilR_data,</span></span>
<span id="cb29-242"><a href="#cb29-242" aria-hidden="true" tabindex="-1"></a><span class="in">                                pupil1 = PupilL,</span></span>
<span id="cb29-243"><a href="#cb29-243" aria-hidden="true" tabindex="-1"></a><span class="in">                                pupil2 = PupilR)</span></span>
<span id="cb29-244"><a href="#cb29-244" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-245"><a href="#cb29-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-246"><a href="#cb29-246" aria-hidden="true" tabindex="-1"></a>**Pwa pwa pwaaaaa...!!**ü§¶‚Äç‚ôÇÔ∏è We got an error!</span>
<span id="cb29-247"><a href="#cb29-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-248"><a href="#cb29-248" aria-hidden="true" tabindex="-1"></a>What‚Äôs it saying? It‚Äôs telling us that one of the trials is completely full of **NAs**, and since there‚Äôs no data to work with, the function fails. This happens **a lot** when testing infants ‚Äî they don‚Äôt always do what we expect, like watching the screen. Instead, they move around or look away.</span>
<span id="cb29-249"><a href="#cb29-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-250"><a href="#cb29-250" aria-hidden="true" tabindex="-1"></a>We‚Äôll deal with missing data properly later, but for now, we need a quick fix. What can we do? We can simply drop any trials where both pupils (PupilL and PupilR) are entirely NA. This way, we avoid errors and keep the analysis moving.</span>
<span id="cb29-251"><a href="#cb29-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-252"><a href="#cb29-252" aria-hidden="true" tabindex="-1"></a>So let's filter our data and then redo the last two steps (make PupilR_data and then regress data)</span>
<span id="cb29-253"><a href="#cb29-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-256"><a href="#cb29-256" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-257"><a href="#cb29-257" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb29-258"><a href="#cb29-258" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb29-259"><a href="#cb29-259" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the trial data</span></span>
<span id="cb29-260"><a href="#cb29-260" aria-hidden="true" tabindex="-1"></a>Trial_data <span class="ot">&lt;-</span> Trial_data <span class="sc">%&gt;%</span></span>
<span id="cb29-261"><a href="#cb29-261" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(Subject, TrialN) <span class="sc">%&gt;%</span>  <span class="co"># group by Subject and TrialN</span></span>
<span id="cb29-262"><a href="#cb29-262" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">all</span>(<span class="fu">is.na</span>(PupilL) <span class="sc">&amp;</span> <span class="fu">is.na</span>( PupilR))) <span class="sc">%&gt;%</span> <span class="co"># filter out if both PupilR and PupilL are all NA</span></span>
<span id="cb29-263"><a href="#cb29-263" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()  <span class="co"># Remove grouping</span></span>
<span id="cb29-264"><a href="#cb29-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-265"><a href="#cb29-265" aria-hidden="true" tabindex="-1"></a><span class="co"># Make pupilloemtryR data</span></span>
<span id="cb29-266"><a href="#cb29-266" aria-hidden="true" tabindex="-1"></a>PupilR_data <span class="ot">=</span> <span class="fu">make_pupillometryr_data</span>(<span class="at">data =</span> Trial_data,</span>
<span id="cb29-267"><a href="#cb29-267" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">subject =</span> Subject,</span>
<span id="cb29-268"><a href="#cb29-268" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">trial =</span> TrialN,</span>
<span id="cb29-269"><a href="#cb29-269" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">time =</span> Time,</span>
<span id="cb29-270"><a href="#cb29-270" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">condition =</span> Events)</span>
<span id="cb29-271"><a href="#cb29-271" aria-hidden="true" tabindex="-1"></a><span class="co"># Regress data</span></span>
<span id="cb29-272"><a href="#cb29-272" aria-hidden="true" tabindex="-1"></a>Regressed_data <span class="ot">&lt;-</span> <span class="fu">regress_data</span>(<span class="at">data =</span> PupilR_data,</span>
<span id="cb29-273"><a href="#cb29-273" aria-hidden="true" tabindex="-1"></a>                               <span class="at">pupil1 =</span> PupilL,</span>
<span id="cb29-274"><a href="#cb29-274" aria-hidden="true" tabindex="-1"></a>                                <span class="at">pupil2 =</span> PupilR)</span>
<span id="cb29-275"><a href="#cb29-275" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-276"><a href="#cb29-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-277"><a href="#cb29-277" aria-hidden="true" tabindex="-1"></a>And now everything worked!! Perfect!</span>
<span id="cb29-278"><a href="#cb29-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-279"><a href="#cb29-279" aria-hidden="true" tabindex="-1"></a><span class="fu">### Mean pupil</span></span>
<span id="cb29-280"><a href="#cb29-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-281"><a href="#cb29-281" aria-hidden="true" tabindex="-1"></a>As the next steps we will average the two pupil signals. This will create a new variable called mean_pupil</span>
<span id="cb29-282"><a href="#cb29-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-283"><a href="#cb29-283" aria-hidden="true" tabindex="-1"></a><span class="in">```{r MeanData}</span></span>
<span id="cb29-284"><a href="#cb29-284" aria-hidden="true" tabindex="-1"></a><span class="in">#| message: true</span></span>
<span id="cb29-285"><a href="#cb29-285" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb29-286"><a href="#cb29-286" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-height: 25</span></span>
<span id="cb29-287"><a href="#cb29-287" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-width: 40</span></span>
<span id="cb29-288"><a href="#cb29-288" aria-hidden="true" tabindex="-1"></a><span class="in">Mean_data &lt;- calculate_mean_pupil_size(data = Regressed_data, </span></span>
<span id="cb29-289"><a href="#cb29-289" aria-hidden="true" tabindex="-1"></a><span class="in">                                       pupil1 = PupilL, </span></span>
<span id="cb29-290"><a href="#cb29-290" aria-hidden="true" tabindex="-1"></a><span class="in">                                       pupil2 = PupilR)</span></span>
<span id="cb29-291"><a href="#cb29-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-292"><a href="#cb29-292" aria-hidden="true" tabindex="-1"></a><span class="in">plot(Mean_data, pupil = mean_pupil, group = 'condition', geom = 'line')+</span></span>
<span id="cb29-293"><a href="#cb29-293" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw(base_size = 45) +</span></span>
<span id="cb29-294"><a href="#cb29-294" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb29-295"><a href="#cb29-295" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = 'bottom', </span></span>
<span id="cb29-296"><a href="#cb29-296" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.title = element_blank()) +</span></span>
<span id="cb29-297"><a href="#cb29-297" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = guide_legend(override.aes = list(lwd = 20))) </span></span>
<span id="cb29-298"><a href="#cb29-298" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-299"><a href="#cb29-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-300"><a href="#cb29-300" aria-hidden="true" tabindex="-1"></a><span class="fu">### Lowpass</span></span>
<span id="cb29-301"><a href="#cb29-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-302"><a href="#cb29-302" aria-hidden="true" tabindex="-1"></a>Now that we have a single pupil signal, we can move on to filtering it. The goal here is to remove fast noise and fluctuations that aren't relevant to our analysis. Why? Because we know that pupil dilation is a slow physiological signal, and those rapid changes are likely just noise from blinks, eye movements, or measurement errors. By filtering out these fast fluctuations, we can focus on the meaningful changes in pupil dilation that matter for our analysis.</span>
<span id="cb29-303"><a href="#cb29-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-304"><a href="#cb29-304" aria-hidden="true" tabindex="-1"></a><span class="in">```{r Lowpass}</span></span>
<span id="cb29-305"><a href="#cb29-305" aria-hidden="true" tabindex="-1"></a><span class="in">#| message: false</span></span>
<span id="cb29-306"><a href="#cb29-306" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb29-307"><a href="#cb29-307" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-height: 25</span></span>
<span id="cb29-308"><a href="#cb29-308" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-width: 40</span></span>
<span id="cb29-309"><a href="#cb29-309" aria-hidden="true" tabindex="-1"></a><span class="in">filtered_data &lt;- filter_data(data = Mean_data,</span></span>
<span id="cb29-310"><a href="#cb29-310" aria-hidden="true" tabindex="-1"></a><span class="in">                             pupil = mean_pupil,</span></span>
<span id="cb29-311"><a href="#cb29-311" aria-hidden="true" tabindex="-1"></a><span class="in">                             filter = 'median',</span></span>
<span id="cb29-312"><a href="#cb29-312" aria-hidden="true" tabindex="-1"></a><span class="in">                             degree = 11)</span></span>
<span id="cb29-313"><a href="#cb29-313" aria-hidden="true" tabindex="-1"></a><span class="in">plot(filtered_data, pupil = mean_pupil, group = 'condition', geom = 'line')+</span></span>
<span id="cb29-314"><a href="#cb29-314" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw(base_size = 45) +</span></span>
<span id="cb29-315"><a href="#cb29-315" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb29-316"><a href="#cb29-316" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = 'bottom', </span></span>
<span id="cb29-317"><a href="#cb29-317" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.title = element_blank()) +</span></span>
<span id="cb29-318"><a href="#cb29-318" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = guide_legend(override.aes = list(lwd = 20))) </span></span>
<span id="cb29-319"><a href="#cb29-319" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-320"><a href="#cb29-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-321"><a href="#cb29-321" aria-hidden="true" tabindex="-1"></a>There are different ways to filter the data in PupillometryR we suggest you check the actual package website and make decision based on your data (<span class="co">[</span><span class="ot">`filter_data`</span><span class="co">](http://samforbes.me/PupillometryR/reference/filter_data.html)</span>). Here we use a median filter based on a 11 sample window.</span>
<span id="cb29-322"><a href="#cb29-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-323"><a href="#cb29-323" aria-hidden="true" tabindex="-1"></a><span class="fu">### Downsample</span></span>
<span id="cb29-324"><a href="#cb29-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-325"><a href="#cb29-325" aria-hidden="true" tabindex="-1"></a>As mentioned above, Pupil dilation is a slow signal, so 20Hz is enough ‚Äî no need for 300Hz. Downsampling reduces file size, speeds up processing, and naturally smooths the signal by filtering out high-frequency noise, all while preserving the key information we need for analysis. To downsample to 20Hz, we‚Äôll set the timebin size to 50 ms (since 1/20 = 0.05 seconds = 50 ms) and calculate the median for each time bin.</span>
<span id="cb29-326"><a href="#cb29-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-327"><a href="#cb29-327" aria-hidden="true" tabindex="-1"></a><span class="in">```{r Downsample}</span></span>
<span id="cb29-328"><a href="#cb29-328" aria-hidden="true" tabindex="-1"></a><span class="in">#| message: false</span></span>
<span id="cb29-329"><a href="#cb29-329" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb29-330"><a href="#cb29-330" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-height: 25</span></span>
<span id="cb29-331"><a href="#cb29-331" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-width: 40</span></span>
<span id="cb29-332"><a href="#cb29-332" aria-hidden="true" tabindex="-1"></a><span class="in">NewHz = 20</span></span>
<span id="cb29-333"><a href="#cb29-333" aria-hidden="true" tabindex="-1"></a><span class="in">timebinSize = 1/NewHz</span></span>
<span id="cb29-334"><a href="#cb29-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-335"><a href="#cb29-335" aria-hidden="true" tabindex="-1"></a><span class="in">Downsampled_data &lt;- downsample_time_data(data = filtered_data,</span></span>
<span id="cb29-336"><a href="#cb29-336" aria-hidden="true" tabindex="-1"></a><span class="in">                              pupil = mean_pupil,</span></span>
<span id="cb29-337"><a href="#cb29-337" aria-hidden="true" tabindex="-1"></a><span class="in">                              timebin_size = timebinSize,</span></span>
<span id="cb29-338"><a href="#cb29-338" aria-hidden="true" tabindex="-1"></a><span class="in">                              option = 'median')</span></span>
<span id="cb29-339"><a href="#cb29-339" aria-hidden="true" tabindex="-1"></a><span class="in">plot(Downsampled_data, pupil = mean_pupil, group = 'condition', geom = 'line') +</span></span>
<span id="cb29-340"><a href="#cb29-340" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw(base_size = 45) +</span></span>
<span id="cb29-341"><a href="#cb29-341" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb29-342"><a href="#cb29-342" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = 'bottom', </span></span>
<span id="cb29-343"><a href="#cb29-343" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.title = element_blank()) +</span></span>
<span id="cb29-344"><a href="#cb29-344" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = guide_legend(override.aes = list(lwd = 20))) </span></span>
<span id="cb29-345"><a href="#cb29-345" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-346"><a href="#cb29-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-347"><a href="#cb29-347" aria-hidden="true" tabindex="-1"></a><span class="fu">### Trial Rejection</span></span>
<span id="cb29-348"><a href="#cb29-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-349"><a href="#cb29-349" aria-hidden="true" tabindex="-1"></a>Now that our data is smaller and smoother, it‚Äôs a good time to take a look at it. It doesn‚Äôt make sense to keep trials that are mostly missing values, nor does it make sense to keep participants with very few good trials.</span>
<span id="cb29-350"><a href="#cb29-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-351"><a href="#cb29-351" aria-hidden="true" tabindex="-1"></a>While you might already have info on trial counts and participant performance from other sources (like video coding), PupillometryR has a super handy function to check this directly. This way, you can quickly see how many valid trials each participant has and decide which ones to keep or drop.</span>
<span id="cb29-352"><a href="#cb29-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-353"><a href="#cb29-353" aria-hidden="true" tabindex="-1"></a><span class="in">```{r MissingDataframe}</span></span>
<span id="cb29-354"><a href="#cb29-354" aria-hidden="true" tabindex="-1"></a><span class="in">Missing_data &lt;- calculate_missing_data(Downsampled_data,</span></span>
<span id="cb29-355"><a href="#cb29-355" aria-hidden="true" tabindex="-1"></a><span class="in">                                       mean_pupil)</span></span>
<span id="cb29-356"><a href="#cb29-356" aria-hidden="true" tabindex="-1"></a><span class="in">head(Missing_data, n=20)</span></span>
<span id="cb29-357"><a href="#cb29-357" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-358"><a href="#cb29-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-359"><a href="#cb29-359" aria-hidden="true" tabindex="-1"></a>This gives us a new dataframe that shows the amount of missing data for each subject and each trial. While we could manually decide which trials and subjects to keep or remove, PupillometryR makes it easier with the **`clean_missing_data()`** function.</span>
<span id="cb29-360"><a href="#cb29-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-361"><a href="#cb29-361" aria-hidden="true" tabindex="-1"></a>This function lets you set two % thresholds ‚Äî one for trials and one for subjects. Here, we‚Äôll set it to reject trials with more than 25% missing data (keep at least 75% of the data) and reject subjects with more than 25% missing data. This way, we ensure our analysis is based on clean, high-quality data.</span>
<span id="cb29-362"><a href="#cb29-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-363"><a href="#cb29-363" aria-hidden="true" tabindex="-1"></a><span class="in">```{r TrialRejection}</span></span>
<span id="cb29-364"><a href="#cb29-364" aria-hidden="true" tabindex="-1"></a><span class="in">#| message: false</span></span>
<span id="cb29-365"><a href="#cb29-365" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb29-366"><a href="#cb29-366" aria-hidden="true" tabindex="-1"></a><span class="in">Clean_data &lt;- clean_missing_data(Downsampled_data,</span></span>
<span id="cb29-367"><a href="#cb29-367" aria-hidden="true" tabindex="-1"></a><span class="in">                                 pupil = mean_pupil,</span></span>
<span id="cb29-368"><a href="#cb29-368" aria-hidden="true" tabindex="-1"></a><span class="in">                                 trial_threshold = .75,</span></span>
<span id="cb29-369"><a href="#cb29-369" aria-hidden="true" tabindex="-1"></a><span class="in">                                 subject_trial_threshold = .75)</span></span>
<span id="cb29-370"><a href="#cb29-370" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-371"><a href="#cb29-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-372"><a href="#cb29-372" aria-hidden="true" tabindex="-1"></a>::: callout-warning</span>
<span id="cb29-373"><a href="#cb29-373" aria-hidden="true" tabindex="-1"></a>Note that this function calculates the percentage of missing trials based only on the trials present in the dataframe. For example, if a participant only completed one trial (and watched it perfectly) before the session had to stop, the percentage would be calculated on that single trial, and the participant wouldn‚Äôt be rejected.</span>
<span id="cb29-374"><a href="#cb29-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-375"><a href="#cb29-375" aria-hidden="true" tabindex="-1"></a>If you have more complex conditions for excluding participants (e.g., based on total expected trials or additional criteria), you‚Äôll need to handle this manually to ensure subjects are dropped appropriately.</span>
<span id="cb29-376"><a href="#cb29-376" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb29-377"><a href="#cb29-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-378"><a href="#cb29-378" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fill the signal</span></span>
<span id="cb29-379"><a href="#cb29-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-380"><a href="#cb29-380" aria-hidden="true" tabindex="-1"></a>Now our data is clean, but‚Ä¶ while the average signal for each condition looks smooth (as seen in our plots), the data for each individual participant is still noisy. We can still spot blinks and missing data in the signal.</span>
<span id="cb29-381"><a href="#cb29-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-382"><a href="#cb29-382" aria-hidden="true" tabindex="-1"></a>To handle this, we‚Äôll use interpolation to fill in the missing points. Interpolation "connects the dots" between gaps, creating a more continuous and cleaner signal. This step is crucial because large chunks of missing data can distort our analysis, and interpolation allows us to retain more usable data from each participant.</span>
<span id="cb29-383"><a href="#cb29-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-384"><a href="#cb29-384" aria-hidden="true" tabindex="-1"></a><span class="in">```{r PlotBlink}</span></span>
<span id="cb29-385"><a href="#cb29-385" aria-hidden="true" tabindex="-1"></a><span class="in">#| message: false</span></span>
<span id="cb29-386"><a href="#cb29-386" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb29-387"><a href="#cb29-387" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-height: 25</span></span>
<span id="cb29-388"><a href="#cb29-388" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-width: 40</span></span>
<span id="cb29-389"><a href="#cb29-389" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(Clean_data, aes(x = Time, y = mean_pupil, group = TrialN, color= Events))+</span></span>
<span id="cb29-390"><a href="#cb29-390" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line( lwd =1.2)+</span></span>
<span id="cb29-391"><a href="#cb29-391" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(aes(xintercept = 0), linetype= 'dashed', color = 'black', lwd =1.2)+</span></span>
<span id="cb29-392"><a href="#cb29-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-393"><a href="#cb29-393" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(~Subject)+</span></span>
<span id="cb29-394"><a href="#cb29-394" aria-hidden="true" tabindex="-1"></a><span class="in">  ylim(1,6)+</span></span>
<span id="cb29-395"><a href="#cb29-395" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb29-396"><a href="#cb29-396" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw(base_size = 45) +</span></span>
<span id="cb29-397"><a href="#cb29-397" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb29-398"><a href="#cb29-398" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = 'bottom', </span></span>
<span id="cb29-399"><a href="#cb29-399" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.title = element_blank()) +</span></span>
<span id="cb29-400"><a href="#cb29-400" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(y = 'Pupil Size')+</span></span>
<span id="cb29-401"><a href="#cb29-401" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = guide_legend(override.aes = list(lwd = 20))) </span></span>
<span id="cb29-402"><a href="#cb29-402" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-403"><a href="#cb29-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-404"><a href="#cb29-404" aria-hidden="true" tabindex="-1"></a>So to remove these missing values we can interpolate our data. Interpolating is easy with pupillometryR we can simply:</span>
<span id="cb29-405"><a href="#cb29-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-406"><a href="#cb29-406" aria-hidden="true" tabindex="-1"></a><span class="in">```{r WrongInterpolation}</span></span>
<span id="cb29-407"><a href="#cb29-407" aria-hidden="true" tabindex="-1"></a><span class="in">#| message: false</span></span>
<span id="cb29-408"><a href="#cb29-408" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb29-409"><a href="#cb29-409" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-height: 25</span></span>
<span id="cb29-410"><a href="#cb29-410" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-width: 40</span></span>
<span id="cb29-411"><a href="#cb29-411" aria-hidden="true" tabindex="-1"></a><span class="in">Int_data &lt;- interpolate_data(data = Clean_data,</span></span>
<span id="cb29-412"><a href="#cb29-412" aria-hidden="true" tabindex="-1"></a><span class="in">                             pupil = mean_pupil,</span></span>
<span id="cb29-413"><a href="#cb29-413" aria-hidden="true" tabindex="-1"></a><span class="in">                             type = 'linear')</span></span>
<span id="cb29-414"><a href="#cb29-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-415"><a href="#cb29-415" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(Int_data, aes(x = Time, y = mean_pupil, group = TrialN, color = Events))+</span></span>
<span id="cb29-416"><a href="#cb29-416" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(lwd =1.2)+</span></span>
<span id="cb29-417"><a href="#cb29-417" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(aes(xintercept = 0), linetype= 'dashed', color = 'black', lwd =1.2)+</span></span>
<span id="cb29-418"><a href="#cb29-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-419"><a href="#cb29-419" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(~Subject)+</span></span>
<span id="cb29-420"><a href="#cb29-420" aria-hidden="true" tabindex="-1"></a><span class="in">  ylim(1,6)+</span></span>
<span id="cb29-421"><a href="#cb29-421" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb29-422"><a href="#cb29-422" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw(base_size = 45) +</span></span>
<span id="cb29-423"><a href="#cb29-423" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb29-424"><a href="#cb29-424" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = 'bottom', </span></span>
<span id="cb29-425"><a href="#cb29-425" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.title = element_blank()) +</span></span>
<span id="cb29-426"><a href="#cb29-426" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(y = 'Pupil Size')+</span></span>
<span id="cb29-427"><a href="#cb29-427" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = guide_legend(override.aes = list(lwd = 20))) </span></span>
<span id="cb29-428"><a href="#cb29-428" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-429"><a href="#cb29-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-430"><a href="#cb29-430" aria-hidden="true" tabindex="-1"></a>**Done!!** Well, you‚Äôve probably noticed something strange... When there‚Äôs a blink, the pupil signal can rapidly decrease until it‚Äôs completely missing. Right now, this drop gets interpolated, and the result is a weird, unrealistic curve where the signal dips sharply and then smoothly recovers. This makes our data look horrible! üò©</span>
<span id="cb29-431"><a href="#cb29-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-432"><a href="#cb29-432" aria-hidden="true" tabindex="-1"></a>**Let‚Äôs fix it!**</span>
<span id="cb29-433"><a href="#cb29-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-434"><a href="#cb29-434" aria-hidden="true" tabindex="-1"></a>To do this, we‚Äôll use PupillometryR‚Äôs blink detection functions. There are two main ways to detect blinks:</span>
<span id="cb29-435"><a href="#cb29-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-436"><a href="#cb29-436" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span><span class="co">[</span><span class="ot">**Based on size**</span><span class="co">](http://samforbes.me/PupillometryR/reference/detect_blinks_by_size.html)</span> ‚Äî detects pupil size.</span>
<span id="cb29-437"><a href="#cb29-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-438"><a href="#cb29-438" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span><span class="co">[</span><span class="ot">**Based on velocity**</span><span class="co">](http://samforbes.me/PupillometryR/reference/detect_blinks_by_velocity.html)</span> ‚Äî detects rapid changes in pupil size (which happens during blinks).</span>
<span id="cb29-439"><a href="#cb29-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-440"><a href="#cb29-440" aria-hidden="true" tabindex="-1"></a>Here, we‚Äôll use detection by velocity. We set a velocity threshold to detect when the pupil size changes too quickly. To ensure we capture the full blink, we use <span class="in">`extend_forward`</span> and <span class="in">`extend_back`</span> to expand the blink window, including the fast decrease in pupil size. The key idea is to make the entire blink period NA, not just the moment the pupil disappears. This prevents interpolation from creating unrealistic artifacts. When we interpolate, the process skips over the entire blink period, resulting in a cleaner, more natural signal.</span>
<span id="cb29-441"><a href="#cb29-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-442"><a href="#cb29-442" aria-hidden="true" tabindex="-1"></a><span class="in">```{r BlinkRemoval}</span></span>
<span id="cb29-443"><a href="#cb29-443" aria-hidden="true" tabindex="-1"></a><span class="in">#| message: false</span></span>
<span id="cb29-444"><a href="#cb29-444" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb29-445"><a href="#cb29-445" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-height: 25</span></span>
<span id="cb29-446"><a href="#cb29-446" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-width: 40</span></span>
<span id="cb29-447"><a href="#cb29-447" aria-hidden="true" tabindex="-1"></a><span class="in">Blink_data = detect_blinks_by_velocity(</span></span>
<span id="cb29-448"><a href="#cb29-448" aria-hidden="true" tabindex="-1"></a><span class="in">    Clean_data,</span></span>
<span id="cb29-449"><a href="#cb29-449" aria-hidden="true" tabindex="-1"></a><span class="in">    mean_pupil,</span></span>
<span id="cb29-450"><a href="#cb29-450" aria-hidden="true" tabindex="-1"></a><span class="in">    threshold = 0.1,</span></span>
<span id="cb29-451"><a href="#cb29-451" aria-hidden="true" tabindex="-1"></a><span class="in">    extend_forward = 50,</span></span>
<span id="cb29-452"><a href="#cb29-452" aria-hidden="true" tabindex="-1"></a><span class="in">    extend_back = 50)</span></span>
<span id="cb29-453"><a href="#cb29-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-454"><a href="#cb29-454" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(Blink_data, aes(x = Time, y = mean_pupil, group = TrialN, color=Events))+</span></span>
<span id="cb29-455"><a href="#cb29-455" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(lwd =1.2)+</span></span>
<span id="cb29-456"><a href="#cb29-456" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(aes(xintercept = 0), linetype= 'dashed', color = 'black', lwd =1.2)+</span></span>
<span id="cb29-457"><a href="#cb29-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-458"><a href="#cb29-458" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(~Subject)+</span></span>
<span id="cb29-459"><a href="#cb29-459" aria-hidden="true" tabindex="-1"></a><span class="in">  ylim(1,6)+</span></span>
<span id="cb29-460"><a href="#cb29-460" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb29-461"><a href="#cb29-461" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw(base_size = 45) +</span></span>
<span id="cb29-462"><a href="#cb29-462" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb29-463"><a href="#cb29-463" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = 'bottom', </span></span>
<span id="cb29-464"><a href="#cb29-464" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.title = element_blank()) +</span></span>
<span id="cb29-465"><a href="#cb29-465" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(y = 'Pupil Size')+</span></span>
<span id="cb29-466"><a href="#cb29-466" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = guide_legend(override.aes = list(lwd = 20))) </span></span>
<span id="cb29-467"><a href="#cb29-467" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-468"><a href="#cb29-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-469"><a href="#cb29-469" aria-hidden="true" tabindex="-1"></a>See !! now the rapid shrinking disappeared and we can now interpolate</span>
<span id="cb29-470"><a href="#cb29-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-471"><a href="#cb29-471" aria-hidden="true" tabindex="-1"></a><span class="in">```{r Interpolation2}</span></span>
<span id="cb29-472"><a href="#cb29-472" aria-hidden="true" tabindex="-1"></a><span class="in">#| message: false</span></span>
<span id="cb29-473"><a href="#cb29-473" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb29-474"><a href="#cb29-474" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-height: 25</span></span>
<span id="cb29-475"><a href="#cb29-475" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-width: 40</span></span>
<span id="cb29-476"><a href="#cb29-476" aria-hidden="true" tabindex="-1"></a><span class="in">Int_data &lt;- interpolate_data(data = Blink_data,</span></span>
<span id="cb29-477"><a href="#cb29-477" aria-hidden="true" tabindex="-1"></a><span class="in">                             pupil = mean_pupil,</span></span>
<span id="cb29-478"><a href="#cb29-478" aria-hidden="true" tabindex="-1"></a><span class="in">                             type = 'linear')</span></span>
<span id="cb29-479"><a href="#cb29-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-480"><a href="#cb29-480" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(Int_data, aes(x = Time, y = mean_pupil, group = TrialN, color=Events))+</span></span>
<span id="cb29-481"><a href="#cb29-481" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(lwd =1.2)+</span></span>
<span id="cb29-482"><a href="#cb29-482" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(aes(xintercept = 0), linetype= 'dashed', color = 'black', lwd =1.2)+</span></span>
<span id="cb29-483"><a href="#cb29-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-484"><a href="#cb29-484" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(~Subject)+</span></span>
<span id="cb29-485"><a href="#cb29-485" aria-hidden="true" tabindex="-1"></a><span class="in">  ylim(1,6)+</span></span>
<span id="cb29-486"><a href="#cb29-486" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb29-487"><a href="#cb29-487" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw(base_size = 45) +</span></span>
<span id="cb29-488"><a href="#cb29-488" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb29-489"><a href="#cb29-489" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = 'bottom', </span></span>
<span id="cb29-490"><a href="#cb29-490" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.title = element_blank()) +</span></span>
<span id="cb29-491"><a href="#cb29-491" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(y = 'Pupil Size')+</span></span>
<span id="cb29-492"><a href="#cb29-492" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = guide_legend(override.aes = list(lwd = 20))) </span></span>
<span id="cb29-493"><a href="#cb29-493" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-494"><a href="#cb29-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-495"><a href="#cb29-495" aria-hidden="true" tabindex="-1"></a>Look how beautiful our signal is now!! üòç Good job!!!</span>
<span id="cb29-496"><a href="#cb29-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-497"><a href="#cb29-497" aria-hidden="true" tabindex="-1"></a>::: callout-caution</span>
<span id="cb29-498"><a href="#cb29-498" aria-hidden="true" tabindex="-1"></a>It‚Äôs not always the case that blinks will have a rapid drop in pupil size followed by missing values. Sometimes, you‚Äôll just get missing values straight away. This can depend on the eye tracker, sampling rate, and even the population you‚Äôre testing (like infants who might look away suddenly). Because of this, blink detection may not always be necessary. The best approach is to check your data before deciding. And how do you check it? Plotting! Plotting your signal is the best way to see if blinks are causing rapid drops or if you‚Äôre just dealing with missing data. Let the data guide your decisions.</span>
<span id="cb29-499"><a href="#cb29-499" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb29-500"><a href="#cb29-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-501"><a href="#cb29-501" aria-hidden="true" tabindex="-1"></a><span class="fu">### Baseline Correction</span></span>
<span id="cb29-502"><a href="#cb29-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-503"><a href="#cb29-503" aria-hidden="true" tabindex="-1"></a>Good job getting this far!! We‚Äôre now at the final step of our pre-processing: baseline correction.</span>
<span id="cb29-504"><a href="#cb29-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-505"><a href="#cb29-505" aria-hidden="true" tabindex="-1"></a>Baseline correction helps remove variability between trials and participants, like differences in baseline pupil size caused by individual differences, fatigue, or random fluctuations. By doing this, we can focus only on the variability caused by our paradigm. This step ensures that any changes we see in pupil size are truly driven by the experimental conditions, not irrelevant noise. Let‚Äôs get it done!</span>
<span id="cb29-506"><a href="#cb29-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-507"><a href="#cb29-507" aria-hidden="true" tabindex="-1"></a><span class="in">```{r BaselineCorrection}</span></span>
<span id="cb29-508"><a href="#cb29-508" aria-hidden="true" tabindex="-1"></a><span class="in">#| message: false</span></span>
<span id="cb29-509"><a href="#cb29-509" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb29-510"><a href="#cb29-510" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-height: 25</span></span>
<span id="cb29-511"><a href="#cb29-511" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-width: 40</span></span>
<span id="cb29-512"><a href="#cb29-512" aria-hidden="true" tabindex="-1"></a><span class="in">Base_data &lt;- baseline_data(data = Int_data,</span></span>
<span id="cb29-513"><a href="#cb29-513" aria-hidden="true" tabindex="-1"></a><span class="in">                           pupil = mean_pupil,</span></span>
<span id="cb29-514"><a href="#cb29-514" aria-hidden="true" tabindex="-1"></a><span class="in">                           start = -100,</span></span>
<span id="cb29-515"><a href="#cb29-515" aria-hidden="true" tabindex="-1"></a><span class="in">                           stop = 0)</span></span>
<span id="cb29-516"><a href="#cb29-516" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-517"><a href="#cb29-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-518"><a href="#cb29-518" aria-hidden="true" tabindex="-1"></a>Let's plot it to see what baseline correction is actually doing!! We will plot both the average signal using the <span class="in">`plot`</span> function (with some addition inforamtion about color and theme) and using ggplot to plot the data for each subject separately.</span>
<span id="cb29-519"><a href="#cb29-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-520"><a href="#cb29-520" aria-hidden="true" tabindex="-1"></a><span class="in">```{r FinalPlot}</span></span>
<span id="cb29-521"><a href="#cb29-521" aria-hidden="true" tabindex="-1"></a><span class="in">#| message: false</span></span>
<span id="cb29-522"><a href="#cb29-522" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb29-523"><a href="#cb29-523" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-height: 25</span></span>
<span id="cb29-524"><a href="#cb29-524" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-width: 40</span></span>
<span id="cb29-525"><a href="#cb29-525" aria-hidden="true" tabindex="-1"></a><span class="in">One = plot(Base_data, pupil = mean_pupil, group = 'condition')+</span></span>
<span id="cb29-526"><a href="#cb29-526" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw(base_size = 45) +</span></span>
<span id="cb29-527"><a href="#cb29-527" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = 'none')</span></span>
<span id="cb29-528"><a href="#cb29-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-529"><a href="#cb29-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-530"><a href="#cb29-530" aria-hidden="true" tabindex="-1"></a><span class="in">Two = ggplot(Base_data, aes(x = Time, y = mean_pupil, group = TrialN, color = Events))+</span></span>
<span id="cb29-531"><a href="#cb29-531" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(lwd =1.2)+</span></span>
<span id="cb29-532"><a href="#cb29-532" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(aes(xintercept = 0), linetype= 'dashed', color = 'black', lwd =1.2)+</span></span>
<span id="cb29-533"><a href="#cb29-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-534"><a href="#cb29-534" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(~Subject)+</span></span>
<span id="cb29-535"><a href="#cb29-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-536"><a href="#cb29-536" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw(base_size = 45) +</span></span>
<span id="cb29-537"><a href="#cb29-537" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb29-538"><a href="#cb29-538" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = 'bottom', </span></span>
<span id="cb29-539"><a href="#cb29-539" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.title = element_blank()) +</span></span>
<span id="cb29-540"><a href="#cb29-540" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(y = 'Pupil Size')+</span></span>
<span id="cb29-541"><a href="#cb29-541" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = guide_legend(override.aes = list(lwd = 20))) </span></span>
<span id="cb29-542"><a href="#cb29-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-543"><a href="#cb29-543" aria-hidden="true" tabindex="-1"></a><span class="in"># Using patchwork to put the plot toghether</span></span>
<span id="cb29-544"><a href="#cb29-544" aria-hidden="true" tabindex="-1"></a><span class="in">One / Two</span></span>
<span id="cb29-545"><a href="#cb29-545" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-546"><a href="#cb29-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-547"><a href="#cb29-547" aria-hidden="true" tabindex="-1"></a><span class="fu">### Save and analysis</span></span>
<span id="cb29-548"><a href="#cb29-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-549"><a href="#cb29-549" aria-hidden="true" tabindex="-1"></a>This tutorial will not cover the analysis of pupil dilation. We‚Äôll stop here since, after baseline correction, the data is ready to be explored and analyzed. From this point on, we‚Äôll shift from **pre-processing** to **analysis**, so it‚Äôs a good idea to save the data as a simple *.csv* file for easy access and future use.</span>
<span id="cb29-550"><a href="#cb29-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-551"><a href="#cb29-551" aria-hidden="true" tabindex="-1"></a><span class="in">```{r Save}</span></span>
<span id="cb29-552"><a href="#cb29-552" aria-hidden="true" tabindex="-1"></a><span class="in">#| message: false</span></span>
<span id="cb29-553"><a href="#cb29-553" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb29-554"><a href="#cb29-554" aria-hidden="true" tabindex="-1"></a><span class="in">#| eco: false</span></span>
<span id="cb29-555"><a href="#cb29-555" aria-hidden="true" tabindex="-1"></a><span class="in">write.csv(Base_data,"..\\..\\resources\\Pupillometry\\ProcessedPupilData.csv")</span></span>
<span id="cb29-556"><a href="#cb29-556" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-557"><a href="#cb29-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-558"><a href="#cb29-558" aria-hidden="true" tabindex="-1"></a>There are multiple ways to analyze pupil data, and we‚Äôll show you some of our favorite methods in a dedicated tutorial: **Analyze Pupil Dilation**.</span>
<span id="cb29-559"><a href="#cb29-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-560"><a href="#cb29-560" aria-hidden="true" tabindex="-1"></a><span class="fu">## All code</span></span>
<span id="cb29-561"><a href="#cb29-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-562"><a href="#cb29-562" aria-hidden="true" tabindex="-1"></a>Here below we report the whole code we went trough this tutorial as an unique scrit to make it easier for you to copy and explore it in it's entirety. We</span>
<span id="cb29-563"><a href="#cb29-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-564"><a href="#cb29-564" aria-hidden="true" tabindex="-1"></a><span class="in">```{r FinalCode}</span></span>
<span id="cb29-565"><a href="#cb29-565" aria-hidden="true" tabindex="-1"></a><span class="in">#| eval: false</span></span>
<span id="cb29-566"><a href="#cb29-566" aria-hidden="true" tabindex="-1"></a><span class="in"># Setting and Libraries -----------------------------------------------------------------</span></span>
<span id="cb29-567"><a href="#cb29-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-568"><a href="#cb29-568" aria-hidden="true" tabindex="-1"></a><span class="in">library(PupillometryR)</span></span>
<span id="cb29-569"><a href="#cb29-569" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)</span></span>
<span id="cb29-570"><a href="#cb29-570" aria-hidden="true" tabindex="-1"></a><span class="in">library(patchwork)</span></span>
<span id="cb29-571"><a href="#cb29-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-572"><a href="#cb29-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-573"><a href="#cb29-573" aria-hidden="true" tabindex="-1"></a><span class="in"># Read Data -----------------------------------------------------------------</span></span>
<span id="cb29-574"><a href="#cb29-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-575"><a href="#cb29-575" aria-hidden="true" tabindex="-1"></a><span class="in">Raw_data = read.csv("..\\..\\resources\\Pupillometry\\PupilData.csv")</span></span>
<span id="cb29-576"><a href="#cb29-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-577"><a href="#cb29-577" aria-hidden="true" tabindex="-1"></a><span class="in">head(Raw_data)</span></span>
<span id="cb29-578"><a href="#cb29-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-579"><a href="#cb29-579" aria-hidden="true" tabindex="-1"></a><span class="in">## Plot Raw Data -----------------------------------------------------------------</span></span>
<span id="cb29-580"><a href="#cb29-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-581"><a href="#cb29-581" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(Raw_data, aes(x = Time, y = PupilR)) +</span></span>
<span id="cb29-582"><a href="#cb29-582" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(aes(y = PupilR, color = 'Pupil Right'), lwd = 1.2) +</span></span>
<span id="cb29-583"><a href="#cb29-583" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(aes(y = PupilL, color = 'Pupil Left'), lwd = 1.2) +</span></span>
<span id="cb29-584"><a href="#cb29-584" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(data = Raw_data |&gt; dplyr::filter(!is.na(Events)), aes(xintercept = Time, color = Events), linetype = 'dashed') +</span></span>
<span id="cb29-585"><a href="#cb29-585" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(~Subject) +</span></span>
<span id="cb29-586"><a href="#cb29-586" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw(base_size = 35) +</span></span>
<span id="cb29-587"><a href="#cb29-587" aria-hidden="true" tabindex="-1"></a><span class="in">  ylim(1, 6) +</span></span>
<span id="cb29-588"><a href="#cb29-588" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(values = c('Pupil Right' = '#4A6274', 'Pupil Left' = '#E2725A')) +</span></span>
<span id="cb29-589"><a href="#cb29-589" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = 'bottom') +</span></span>
<span id="cb29-590"><a href="#cb29-590" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = guide_legend(override.aes = list(lwd = 20)))</span></span>
<span id="cb29-591"><a href="#cb29-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-592"><a href="#cb29-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-593"><a href="#cb29-593" aria-hidden="true" tabindex="-1"></a><span class="in"># Prepare Data -----------------------------------------------------------------</span></span>
<span id="cb29-594"><a href="#cb29-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-595"><a href="#cb29-595" aria-hidden="true" tabindex="-1"></a><span class="in">## Extract Events -----------------------------------------------------------------</span></span>
<span id="cb29-596"><a href="#cb29-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-597"><a href="#cb29-597" aria-hidden="true" tabindex="-1"></a><span class="in">Events_to_keep = c('Circle','Square')</span></span>
<span id="cb29-598"><a href="#cb29-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-599"><a href="#cb29-599" aria-hidden="true" tabindex="-1"></a><span class="in">Events = filter(Raw_data, Events %in% Events_to_keep)</span></span>
<span id="cb29-600"><a href="#cb29-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-601"><a href="#cb29-601" aria-hidden="true" tabindex="-1"></a><span class="in">head(Events)</span></span>
<span id="cb29-602"><a href="#cb29-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-603"><a href="#cb29-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-604"><a href="#cb29-604" aria-hidden="true" tabindex="-1"></a><span class="in">## Event Settings -----------------------------------------------------------------</span></span>
<span id="cb29-605"><a href="#cb29-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-606"><a href="#cb29-606" aria-hidden="true" tabindex="-1"></a><span class="in">Pre_stim = 100</span></span>
<span id="cb29-607"><a href="#cb29-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-608"><a href="#cb29-608" aria-hidden="true" tabindex="-1"></a><span class="in">Post_stim = 2000</span></span>
<span id="cb29-609"><a href="#cb29-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-610"><a href="#cb29-610" aria-hidden="true" tabindex="-1"></a><span class="in">Fs = 300</span></span>
<span id="cb29-611"><a href="#cb29-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-612"><a href="#cb29-612" aria-hidden="true" tabindex="-1"></a><span class="in">Time = seq(from = -Pre_stim, by = 1000 / Fs, length.out = (Pre_stim + Post_stim) / 1000 * 300 - 1)</span></span>
<span id="cb29-613"><a href="#cb29-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-614"><a href="#cb29-614" aria-hidden="true" tabindex="-1"></a><span class="in">Trial_data = Raw_data</span></span>
<span id="cb29-615"><a href="#cb29-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-616"><a href="#cb29-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-617"><a href="#cb29-617" aria-hidden="true" tabindex="-1"></a><span class="in">## Extend Events -----------------------------------------------------------------</span></span>
<span id="cb29-618"><a href="#cb29-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-619"><a href="#cb29-619" aria-hidden="true" tabindex="-1"></a><span class="in">for (trial in 1:nrow(Events)) {</span></span>
<span id="cb29-620"><a href="#cb29-620" aria-hidden="true" tabindex="-1"></a><span class="in">  Sub = Events[trial, 'Subject']</span></span>
<span id="cb29-621"><a href="#cb29-621" aria-hidden="true" tabindex="-1"></a><span class="in">  Event = Events[trial, 'Events']</span></span>
<span id="cb29-622"><a href="#cb29-622" aria-hidden="true" tabindex="-1"></a><span class="in">  TrialN = Events[trial, 'TrialN']</span></span>
<span id="cb29-623"><a href="#cb29-623" aria-hidden="true" tabindex="-1"></a><span class="in">  Onset = Events[trial, 'Time']</span></span>
<span id="cb29-624"><a href="#cb29-624" aria-hidden="true" tabindex="-1"></a><span class="in">  rows_to_update = which(Trial_data$Subject == Sub &amp;</span></span>
<span id="cb29-625"><a href="#cb29-625" aria-hidden="true" tabindex="-1"></a><span class="in">                           Trial_data$Time &gt;= (Onset - Pre_stim) &amp;</span></span>
<span id="cb29-626"><a href="#cb29-626" aria-hidden="true" tabindex="-1"></a><span class="in">                           Trial_data$Time &lt; (Onset + Post_stim))</span></span>
<span id="cb29-627"><a href="#cb29-627" aria-hidden="true" tabindex="-1"></a><span class="in">  Trial_data[rows_to_update, 'Time'] = Time</span></span>
<span id="cb29-628"><a href="#cb29-628" aria-hidden="true" tabindex="-1"></a><span class="in">  Trial_data[rows_to_update, 'Events'] = Event</span></span>
<span id="cb29-629"><a href="#cb29-629" aria-hidden="true" tabindex="-1"></a><span class="in">  Trial_data[rows_to_update, 'TrialN'] = TrialN</span></span>
<span id="cb29-630"><a href="#cb29-630" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb29-631"><a href="#cb29-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-632"><a href="#cb29-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-633"><a href="#cb29-633" aria-hidden="true" tabindex="-1"></a><span class="in">## Filter Events -----------------------------------------------------------------</span></span>
<span id="cb29-634"><a href="#cb29-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-635"><a href="#cb29-635" aria-hidden="true" tabindex="-1"></a><span class="in">Trial_data = Trial_data %&gt;% </span></span>
<span id="cb29-636"><a href="#cb29-636" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(Events %in% Events_to_keep)</span></span>
<span id="cb29-637"><a href="#cb29-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-638"><a href="#cb29-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-639"><a href="#cb29-639" aria-hidden="true" tabindex="-1"></a><span class="in">### Plot Events -----------------------------------------------------------------</span></span>
<span id="cb29-640"><a href="#cb29-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-641"><a href="#cb29-641" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(Trial_data, aes(x = Time, y = PupilR, group = TrialN)) +</span></span>
<span id="cb29-642"><a href="#cb29-642" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(aes(y = PupilR, color = 'Pupil Right'), lwd = 1.2) +</span></span>
<span id="cb29-643"><a href="#cb29-643" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(aes(y = PupilL, color = 'Pupil Left'), lwd = 1.2) +</span></span>
<span id="cb29-644"><a href="#cb29-644" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(aes(xintercept = 0), linetype = 'dashed', color = 'black', lwd = 1.2) +</span></span>
<span id="cb29-645"><a href="#cb29-645" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(~Subject) +</span></span>
<span id="cb29-646"><a href="#cb29-646" aria-hidden="true" tabindex="-1"></a><span class="in">  ylim(1, 6) +</span></span>
<span id="cb29-647"><a href="#cb29-647" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(values = c('Pupil Right' = '#4A6274', 'Pupil Left' = '#E2725A')) +</span></span>
<span id="cb29-648"><a href="#cb29-648" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw(base_size = 35) +</span></span>
<span id="cb29-649"><a href="#cb29-649" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = 'bottom', legend.title = element_blank()) +</span></span>
<span id="cb29-650"><a href="#cb29-650" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = guide_legend(override.aes = list(lwd = 20)))</span></span>
<span id="cb29-651"><a href="#cb29-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-652"><a href="#cb29-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-653"><a href="#cb29-653" aria-hidden="true" tabindex="-1"></a><span class="in"># Pre-processing -----------------------------------------------------------------</span></span>
<span id="cb29-654"><a href="#cb29-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-655"><a href="#cb29-655" aria-hidden="true" tabindex="-1"></a><span class="in">## Make PupillometryR Data -----------------------------------------------------------------</span></span>
<span id="cb29-656"><a href="#cb29-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-657"><a href="#cb29-657" aria-hidden="true" tabindex="-1"></a><span class="in">PupilR_data = make_pupillometryr_data(data = Trial_data,</span></span>
<span id="cb29-658"><a href="#cb29-658" aria-hidden="true" tabindex="-1"></a><span class="in">                                      subject = Subject,</span></span>
<span id="cb29-659"><a href="#cb29-659" aria-hidden="true" tabindex="-1"></a><span class="in">                                      trial = TrialN,</span></span>
<span id="cb29-660"><a href="#cb29-660" aria-hidden="true" tabindex="-1"></a><span class="in">                                      time = Time,</span></span>
<span id="cb29-661"><a href="#cb29-661" aria-hidden="true" tabindex="-1"></a><span class="in">                                      condition = Events)</span></span>
<span id="cb29-662"><a href="#cb29-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-663"><a href="#cb29-663" aria-hidden="true" tabindex="-1"></a><span class="in">### Plot ------------------------------------------------------------------</span></span>
<span id="cb29-664"><a href="#cb29-664" aria-hidden="true" tabindex="-1"></a><span class="in">plot(PupilR_data, pupil = PupilL, group = 'condition', geom = 'line') +</span></span>
<span id="cb29-665"><a href="#cb29-665" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw(base_size = 45) +</span></span>
<span id="cb29-666"><a href="#cb29-666" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb29-667"><a href="#cb29-667" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = 'bottom', </span></span>
<span id="cb29-668"><a href="#cb29-668" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.title = element_blank()) +</span></span>
<span id="cb29-669"><a href="#cb29-669" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = guide_legend(override.aes = list(lwd = 20))) </span></span>
<span id="cb29-670"><a href="#cb29-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-671"><a href="#cb29-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-672"><a href="#cb29-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-673"><a href="#cb29-673" aria-hidden="true" tabindex="-1"></a><span class="in">## Regress Data -----------------------------------------------------------------</span></span>
<span id="cb29-674"><a href="#cb29-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-675"><a href="#cb29-675" aria-hidden="true" tabindex="-1"></a><span class="in">Regressed_data &lt;- regress_data(data = PupilR_data,</span></span>
<span id="cb29-676"><a href="#cb29-676" aria-hidden="true" tabindex="-1"></a><span class="in">                               pupil1 = PupilL,</span></span>
<span id="cb29-677"><a href="#cb29-677" aria-hidden="true" tabindex="-1"></a><span class="in">                               pupil2 = PupilR)</span></span>
<span id="cb29-678"><a href="#cb29-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-679"><a href="#cb29-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-680"><a href="#cb29-680" aria-hidden="true" tabindex="-1"></a><span class="in">## Filter Out Trials with NA -----------------------------------------------------------------</span></span>
<span id="cb29-681"><a href="#cb29-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-682"><a href="#cb29-682" aria-hidden="true" tabindex="-1"></a><span class="in">Trial_data &lt;- Trial_data %&gt;%</span></span>
<span id="cb29-683"><a href="#cb29-683" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(Subject, TrialN) %&gt;%</span></span>
<span id="cb29-684"><a href="#cb29-684" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(!all(is.na(PupilL) &amp; is.na(PupilR))) %&gt;%</span></span>
<span id="cb29-685"><a href="#cb29-685" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup()</span></span>
<span id="cb29-686"><a href="#cb29-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-687"><a href="#cb29-687" aria-hidden="true" tabindex="-1"></a><span class="in">PupilR_data = make_pupillometryr_data(data = Trial_data,</span></span>
<span id="cb29-688"><a href="#cb29-688" aria-hidden="true" tabindex="-1"></a><span class="in">                                      subject = Subject,</span></span>
<span id="cb29-689"><a href="#cb29-689" aria-hidden="true" tabindex="-1"></a><span class="in">                                      trial = TrialN,</span></span>
<span id="cb29-690"><a href="#cb29-690" aria-hidden="true" tabindex="-1"></a><span class="in">                                      time = Time,</span></span>
<span id="cb29-691"><a href="#cb29-691" aria-hidden="true" tabindex="-1"></a><span class="in">                                      condition = Events)</span></span>
<span id="cb29-692"><a href="#cb29-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-693"><a href="#cb29-693" aria-hidden="true" tabindex="-1"></a><span class="in">Regressed_data &lt;- regress_data(data = PupilR_data,</span></span>
<span id="cb29-694"><a href="#cb29-694" aria-hidden="true" tabindex="-1"></a><span class="in">                               pupil1 = PupilL,</span></span>
<span id="cb29-695"><a href="#cb29-695" aria-hidden="true" tabindex="-1"></a><span class="in">                               pupil2 = PupilR)</span></span>
<span id="cb29-696"><a href="#cb29-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-697"><a href="#cb29-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-698"><a href="#cb29-698" aria-hidden="true" tabindex="-1"></a><span class="in">## Calculate Mean Pupil -----------------------------------------------------------------</span></span>
<span id="cb29-699"><a href="#cb29-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-700"><a href="#cb29-700" aria-hidden="true" tabindex="-1"></a><span class="in">Mean_data &lt;- calculate_mean_pupil_size(data = Regressed_data, </span></span>
<span id="cb29-701"><a href="#cb29-701" aria-hidden="true" tabindex="-1"></a><span class="in">                                       pupil1 = PupilL, </span></span>
<span id="cb29-702"><a href="#cb29-702" aria-hidden="true" tabindex="-1"></a><span class="in">                                       pupil2 = PupilR)</span></span>
<span id="cb29-703"><a href="#cb29-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-704"><a href="#cb29-704" aria-hidden="true" tabindex="-1"></a><span class="in">### Plot --------------------------------------------------------------------</span></span>
<span id="cb29-705"><a href="#cb29-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-706"><a href="#cb29-706" aria-hidden="true" tabindex="-1"></a><span class="in">plot(Mean_data, pupil = mean_pupil, group = 'condition', geom = 'line')+</span></span>
<span id="cb29-707"><a href="#cb29-707" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw(base_size = 45) +</span></span>
<span id="cb29-708"><a href="#cb29-708" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb29-709"><a href="#cb29-709" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = 'bottom', </span></span>
<span id="cb29-710"><a href="#cb29-710" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.title = element_blank()) +</span></span>
<span id="cb29-711"><a href="#cb29-711" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = guide_legend(override.aes = list(lwd = 20))) </span></span>
<span id="cb29-712"><a href="#cb29-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-713"><a href="#cb29-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-714"><a href="#cb29-714" aria-hidden="true" tabindex="-1"></a><span class="in">## Lowpass Filter -----------------------------------------------------------------</span></span>
<span id="cb29-715"><a href="#cb29-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-716"><a href="#cb29-716" aria-hidden="true" tabindex="-1"></a><span class="in">filtered_data &lt;- filter_data(data = Mean_data,</span></span>
<span id="cb29-717"><a href="#cb29-717" aria-hidden="true" tabindex="-1"></a><span class="in">                             pupil = mean_pupil,</span></span>
<span id="cb29-718"><a href="#cb29-718" aria-hidden="true" tabindex="-1"></a><span class="in">                             filter = 'median',</span></span>
<span id="cb29-719"><a href="#cb29-719" aria-hidden="true" tabindex="-1"></a><span class="in">                             degree = 11)</span></span>
<span id="cb29-720"><a href="#cb29-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-721"><a href="#cb29-721" aria-hidden="true" tabindex="-1"></a><span class="in">### Plot --------------------------------------------------------------------</span></span>
<span id="cb29-722"><a href="#cb29-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-723"><a href="#cb29-723" aria-hidden="true" tabindex="-1"></a><span class="in">plot(filtered_data, pupil = mean_pupil, group = 'condition', geom = 'line')+</span></span>
<span id="cb29-724"><a href="#cb29-724" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw(base_size = 45) +</span></span>
<span id="cb29-725"><a href="#cb29-725" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb29-726"><a href="#cb29-726" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = 'bottom', </span></span>
<span id="cb29-727"><a href="#cb29-727" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.title = element_blank()) +</span></span>
<span id="cb29-728"><a href="#cb29-728" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = guide_legend(override.aes = list(lwd = 20))) </span></span>
<span id="cb29-729"><a href="#cb29-729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-730"><a href="#cb29-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-731"><a href="#cb29-731" aria-hidden="true" tabindex="-1"></a><span class="in">## Downsample -----------------------------------------------------------------</span></span>
<span id="cb29-732"><a href="#cb29-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-733"><a href="#cb29-733" aria-hidden="true" tabindex="-1"></a><span class="in">NewHz = 20</span></span>
<span id="cb29-734"><a href="#cb29-734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-735"><a href="#cb29-735" aria-hidden="true" tabindex="-1"></a><span class="in">timebinSize = 1 / NewHz</span></span>
<span id="cb29-736"><a href="#cb29-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-737"><a href="#cb29-737" aria-hidden="true" tabindex="-1"></a><span class="in">Downsampled_data &lt;- downsample_time_data(data = filtered_data,</span></span>
<span id="cb29-738"><a href="#cb29-738" aria-hidden="true" tabindex="-1"></a><span class="in">                                         pupil = mean_pupil,</span></span>
<span id="cb29-739"><a href="#cb29-739" aria-hidden="true" tabindex="-1"></a><span class="in">                                         timebin_size = timebinSize,</span></span>
<span id="cb29-740"><a href="#cb29-740" aria-hidden="true" tabindex="-1"></a><span class="in">                                         option = 'median')</span></span>
<span id="cb29-741"><a href="#cb29-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-742"><a href="#cb29-742" aria-hidden="true" tabindex="-1"></a><span class="in"># Plot --------------------------------------------------------------------</span></span>
<span id="cb29-743"><a href="#cb29-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-744"><a href="#cb29-744" aria-hidden="true" tabindex="-1"></a><span class="in">plot(Downsampled_data, pupil = mean_pupil, group = 'condition', geom = 'line') +</span></span>
<span id="cb29-745"><a href="#cb29-745" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw(base_size = 45) +</span></span>
<span id="cb29-746"><a href="#cb29-746" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb29-747"><a href="#cb29-747" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = 'bottom', </span></span>
<span id="cb29-748"><a href="#cb29-748" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.title = element_blank()) +</span></span>
<span id="cb29-749"><a href="#cb29-749" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = guide_legend(override.aes = list(lwd = 20))) </span></span>
<span id="cb29-750"><a href="#cb29-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-751"><a href="#cb29-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-752"><a href="#cb29-752" aria-hidden="true" tabindex="-1"></a><span class="in">## Calculate Missing Data -----------------------------------------------------------------</span></span>
<span id="cb29-753"><a href="#cb29-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-754"><a href="#cb29-754" aria-hidden="true" tabindex="-1"></a><span class="in">Missing_data &lt;- calculate_missing_data(Downsampled_data, mean_pupil)</span></span>
<span id="cb29-755"><a href="#cb29-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-756"><a href="#cb29-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-757"><a href="#cb29-757" aria-hidden="true" tabindex="-1"></a><span class="in">## Clean Missing Data -----------------------------------------------------------------</span></span>
<span id="cb29-758"><a href="#cb29-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-759"><a href="#cb29-759" aria-hidden="true" tabindex="-1"></a><span class="in">Clean_data &lt;- clean_missing_data(Downsampled_data,</span></span>
<span id="cb29-760"><a href="#cb29-760" aria-hidden="true" tabindex="-1"></a><span class="in">                                 pupil = mean_pupil,</span></span>
<span id="cb29-761"><a href="#cb29-761" aria-hidden="true" tabindex="-1"></a><span class="in">                                 trial_threshold = .75,</span></span>
<span id="cb29-762"><a href="#cb29-762" aria-hidden="true" tabindex="-1"></a><span class="in">                                 subject_trial_threshold = .75)</span></span>
<span id="cb29-763"><a href="#cb29-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-764"><a href="#cb29-764" aria-hidden="true" tabindex="-1"></a><span class="in">### Plot --------------------------------------------------------------------</span></span>
<span id="cb29-765"><a href="#cb29-765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-766"><a href="#cb29-766" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(Clean_data, aes(x = Time, y = mean_pupil, group = TrialN, color= Events))+</span></span>
<span id="cb29-767"><a href="#cb29-767" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line( lwd =1.2)+</span></span>
<span id="cb29-768"><a href="#cb29-768" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(aes(xintercept = 0), linetype= 'dashed', color = 'black', lwd =1.2)+</span></span>
<span id="cb29-769"><a href="#cb29-769" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb29-770"><a href="#cb29-770" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(~Subject)+</span></span>
<span id="cb29-771"><a href="#cb29-771" aria-hidden="true" tabindex="-1"></a><span class="in">  ylim(1,6)+</span></span>
<span id="cb29-772"><a href="#cb29-772" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb29-773"><a href="#cb29-773" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw(base_size = 45) +</span></span>
<span id="cb29-774"><a href="#cb29-774" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb29-775"><a href="#cb29-775" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = 'bottom', </span></span>
<span id="cb29-776"><a href="#cb29-776" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.title = element_blank()) +</span></span>
<span id="cb29-777"><a href="#cb29-777" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = guide_legend(override.aes = list(lwd = 20))) </span></span>
<span id="cb29-778"><a href="#cb29-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-779"><a href="#cb29-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-780"><a href="#cb29-780" aria-hidden="true" tabindex="-1"></a><span class="in">## Detect Blinks -----------------------------------------------------------------</span></span>
<span id="cb29-781"><a href="#cb29-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-782"><a href="#cb29-782" aria-hidden="true" tabindex="-1"></a><span class="in">Blink_data = detect_blinks_by_velocity(</span></span>
<span id="cb29-783"><a href="#cb29-783" aria-hidden="true" tabindex="-1"></a><span class="in">  Clean_data,</span></span>
<span id="cb29-784"><a href="#cb29-784" aria-hidden="true" tabindex="-1"></a><span class="in">  mean_pupil,</span></span>
<span id="cb29-785"><a href="#cb29-785" aria-hidden="true" tabindex="-1"></a><span class="in">  threshold = 0.1,</span></span>
<span id="cb29-786"><a href="#cb29-786" aria-hidden="true" tabindex="-1"></a><span class="in">  extend_forward = 50,</span></span>
<span id="cb29-787"><a href="#cb29-787" aria-hidden="true" tabindex="-1"></a><span class="in">  extend_back = 50)</span></span>
<span id="cb29-788"><a href="#cb29-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-789"><a href="#cb29-789" aria-hidden="true" tabindex="-1"></a><span class="in">### Plot --------------------------------------------------------------------</span></span>
<span id="cb29-790"><a href="#cb29-790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-791"><a href="#cb29-791" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(Blink_data, aes(x = Time, y = mean_pupil, group = TrialN, color=Events))+</span></span>
<span id="cb29-792"><a href="#cb29-792" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(lwd =1.2)+</span></span>
<span id="cb29-793"><a href="#cb29-793" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(aes(xintercept = 0), linetype= 'dashed', color = 'black', lwd =1.2)+</span></span>
<span id="cb29-794"><a href="#cb29-794" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb29-795"><a href="#cb29-795" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(~Subject)+</span></span>
<span id="cb29-796"><a href="#cb29-796" aria-hidden="true" tabindex="-1"></a><span class="in">  ylim(1,6)+</span></span>
<span id="cb29-797"><a href="#cb29-797" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb29-798"><a href="#cb29-798" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw(base_size = 45) +</span></span>
<span id="cb29-799"><a href="#cb29-799" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb29-800"><a href="#cb29-800" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = 'bottom', </span></span>
<span id="cb29-801"><a href="#cb29-801" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.title = element_blank()) +</span></span>
<span id="cb29-802"><a href="#cb29-802" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = guide_legend(override.aes = list(lwd = 20))) </span></span>
<span id="cb29-803"><a href="#cb29-803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-804"><a href="#cb29-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-805"><a href="#cb29-805" aria-hidden="true" tabindex="-1"></a><span class="in">## Interpolate Data -----------------------------------------------------------------</span></span>
<span id="cb29-806"><a href="#cb29-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-807"><a href="#cb29-807" aria-hidden="true" tabindex="-1"></a><span class="in">Int_data &lt;- interpolate_data(data = Blink_data,</span></span>
<span id="cb29-808"><a href="#cb29-808" aria-hidden="true" tabindex="-1"></a><span class="in">                             pupil = mean_pupil,</span></span>
<span id="cb29-809"><a href="#cb29-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-810"><a href="#cb29-810" aria-hidden="true" tabindex="-1"></a><span class="in">### Plot --------------------------------------------------------------------</span></span>
<span id="cb29-811"><a href="#cb29-811" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-812"><a href="#cb29-812" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(Int_data, aes(x = Time, y = mean_pupil, group = TrialN, color = Events))+</span></span>
<span id="cb29-813"><a href="#cb29-813" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(lwd =1.2)+</span></span>
<span id="cb29-814"><a href="#cb29-814" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(aes(xintercept = 0), linetype= 'dashed', color = 'black', lwd =1.2)+</span></span>
<span id="cb29-815"><a href="#cb29-815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-816"><a href="#cb29-816" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(~Subject)+</span></span>
<span id="cb29-817"><a href="#cb29-817" aria-hidden="true" tabindex="-1"></a><span class="in">  ylim(1,6)+</span></span>
<span id="cb29-818"><a href="#cb29-818" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb29-819"><a href="#cb29-819" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw(base_size = 45) +</span></span>
<span id="cb29-820"><a href="#cb29-820" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb29-821"><a href="#cb29-821" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = 'bottom', </span></span>
<span id="cb29-822"><a href="#cb29-822" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.title = element_blank()) +</span></span>
<span id="cb29-823"><a href="#cb29-823" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = guide_legend(override.aes = list(lwd = 20)))</span></span>
<span id="cb29-824"><a href="#cb29-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-825"><a href="#cb29-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-826"><a href="#cb29-826" aria-hidden="true" tabindex="-1"></a><span class="in"># Baseline correction -----------------------------------------------------</span></span>
<span id="cb29-827"><a href="#cb29-827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-828"><a href="#cb29-828" aria-hidden="true" tabindex="-1"></a><span class="in">base_data &lt;- baseline_data(data = Int_data,</span></span>
<span id="cb29-829"><a href="#cb29-829" aria-hidden="true" tabindex="-1"></a><span class="in">                           pupil = mean_pupil,</span></span>
<span id="cb29-830"><a href="#cb29-830" aria-hidden="true" tabindex="-1"></a><span class="in">                           start = -100,</span></span>
<span id="cb29-831"><a href="#cb29-831" aria-hidden="true" tabindex="-1"></a><span class="in">                           stop = 0)</span></span>
<span id="cb29-832"><a href="#cb29-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-833"><a href="#cb29-833" aria-hidden="true" tabindex="-1"></a><span class="in">### Final plot --------------------------------------------------------------</span></span>
<span id="cb29-834"><a href="#cb29-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-835"><a href="#cb29-835" aria-hidden="true" tabindex="-1"></a><span class="in">One = plot(base_data, pupil = mean_pupil, group = 'condition')+</span></span>
<span id="cb29-836"><a href="#cb29-836" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw(base_size = 45) +</span></span>
<span id="cb29-837"><a href="#cb29-837" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = 'none')</span></span>
<span id="cb29-838"><a href="#cb29-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-839"><a href="#cb29-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-840"><a href="#cb29-840" aria-hidden="true" tabindex="-1"></a><span class="in">Two = ggplot(base_data, aes(x = Time, y = mean_pupil, group = TrialN, color = Events))+</span></span>
<span id="cb29-841"><a href="#cb29-841" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(lwd =1.2)+</span></span>
<span id="cb29-842"><a href="#cb29-842" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(aes(xintercept = 0), linetype= 'dashed', color = 'black', lwd =1.2)+</span></span>
<span id="cb29-843"><a href="#cb29-843" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb29-844"><a href="#cb29-844" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(~Subject)+</span></span>
<span id="cb29-845"><a href="#cb29-845" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb29-846"><a href="#cb29-846" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw(base_size = 45) +</span></span>
<span id="cb29-847"><a href="#cb29-847" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb29-848"><a href="#cb29-848" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.position = 'bottom', </span></span>
<span id="cb29-849"><a href="#cb29-849" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.title = element_blank()) +</span></span>
<span id="cb29-850"><a href="#cb29-850" aria-hidden="true" tabindex="-1"></a><span class="in">  guides(color = guide_legend(override.aes = list(lwd = 20))) </span></span>
<span id="cb29-851"><a href="#cb29-851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-852"><a href="#cb29-852" aria-hidden="true" tabindex="-1"></a><span class="in">One / Two</span></span>
<span id="cb29-853"><a href="#cb29-853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-854"><a href="#cb29-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-855"><a href="#cb29-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-856"><a href="#cb29-856" aria-hidden="true" tabindex="-1"></a><span class="in"># Save data ---------------------------------------------------------------</span></span>
<span id="cb29-857"><a href="#cb29-857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-858"><a href="#cb29-858" aria-hidden="true" tabindex="-1"></a><span class="in">write.csv('"..\\..\\resources\\Pupillometry\\ProcessedPupilData.csv"')</span></span>
<span id="cb29-859"><a href="#cb29-859" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
<li class="nav-item compact">
    <a class="nav-link active" href="https://github.com/TommasoGhilardi/DevStart" aria-current="page">
      <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://x.com/DevSciStart">
      <i class="bi bi-twitter" role="img" aria-label="Twitter">
</i> 
    </a>
  </li>  
</ul>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer><script>var lightboxQuarto = GLightbox({"loop":false,"selector":".lightbox","closeEffect":"zoom","openEffect":"zoom","descPosition":"bottom"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>


</body></html>